<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Painted Valentine</title>
  <style>
    :root{
      --glass: rgba(18, 18, 22, .55);
      --panel: rgba(20, 20, 26, .55);
      --panel2: rgba(20, 20, 26, .72);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --accent: rgba(255, 120, 170, .95);

      --cardCream: #f4efe4;
      --cardCream2: #efe7d8;

      --radius: 22px;

      /* Clouds positioning + speed */
      --cloudBandTop: 28vh;
      --cloudBandHeight: 22vh;
      --cloudTravel: 110vw;
      --cloudMinDur: 90s;
      --cloudMaxDur: 120s;
    }

    *{ box-sizing: border-box; }
    html, body { height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }

    body{
      overflow:hidden;
      background:#000;
      color:var(--text);
    }

    /* Background painting */
    .scene{
      position:fixed; inset:0;
      background: url("Midnight.png") center/cover no-repeat;
      transform: translateZ(0);
    }

    /* ‚ÄúTinted glass‚Äù overlay (starts ON, fades OFF after Enter) */
    .tint{
      position:fixed; inset:0;
      background: rgba(25, 30, 55, .55);
      backdrop-filter: blur(10px) saturate(1.1);
      -webkit-backdrop-filter: blur(10px) saturate(1.1);
      transition: opacity 900ms ease;
      pointer-events:none;
      opacity: 1;
    }
    .tint.off{ opacity: 0; }

    /* Stars canvas behind clouds */
    #stars {
      position:fixed; inset:0;
      pointer-events:none;
      z-index: 1;
    }

    /* Clouds layer */
    .clouds{
      position:fixed;
      left:0;
      top: var(--cloudBandTop);
      width:100%;
      height: var(--cloudBandHeight);
      pointer-events:none;
      z-index: 2;
      overflow: visible;
      opacity: .95;
      filter: blur(.2px);
    }

    .cloud{
      position:absolute;
      top: 0;
      width: 520px;
      max-width: 60vw;
      opacity: .55;
      mix-blend-mode: screen;
      will-change: transform, opacity;
    }

    /* Multiple layers for depth */
    .cloud.layer1 { opacity:.42; filter: blur(0.4px); transform: scale(1.00); }
    .cloud.layer2 { opacity:.30; filter: blur(0.9px); transform: scale(1.10); }
    .cloud.layer3 { opacity:.22; filter: blur(1.4px); transform: scale(1.18); }

    @keyframes drift {
      0%   { transform: translateX(-25vw) translateY(var(--y)) scale(var(--s)); opacity: 0; }
      10%  { opacity: var(--o); }
      90%  { opacity: var(--o); }
      100% { transform: translateX(var(--cloudTravel)) translateY(var(--y)) scale(var(--s)); opacity: 0; }
    }

    /* Top line text */
    .tagline{
      position:fixed;
      top: 7vh;
      left: 0; right:0;
      text-align:center;
      z-index: 10;
      font-style: italic;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 30px rgba(0,0,0,.45);
      opacity: 0; /* start hidden (we fade in on YES) */
      transition: opacity 900ms ease;
      padding: 0 14px;
      pointer-events:none;
    }
    .tagline.show{ opacity: 1; }
    .tagline.fade{ opacity: 0; }

    /* Ask / No cards */
    .modalWrap{
      position:fixed; inset:0;
      display:grid;
      place-items:center;
      z-index: 20;
      padding: 18px;
    }

    .card{
      width:min(900px, 92vw);
      border-radius: var(--radius);
      box-shadow: 0 24px 80px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
    }

    .card.cream{
      background:
        radial-gradient(1200px 500px at 30% 10%, rgba(255,255,255,.65), rgba(255,255,255,0)),
        linear-gradient(180deg, var(--cardCream), var(--cardCream2));
      color: rgba(20,20,24,.92);
    }

    .cardInner{
      padding: 34px 36px 26px;
    }

    .hello{
      font-weight: 700;
      font-size: 22px;
      margin: 0 0 10px;
    }
    .p{
      margin: 8px 0;
      line-height: 1.6;
      font-size: 17px;
    }
    .sig{
      margin-top: 18px;
      font-weight: 650;
    }
    .sig small{
      display:block;
      margin-top: 6px;
      opacity:.75;
      font-weight: 500;
    }

    .askRow{
      margin-top: 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .ask{
      font-weight: 800;
      font-size: 20px;
      margin: 8px 0 0;
    }

    .btns{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    button{
      border:0;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 750;
      cursor:pointer;
      transition: transform 120ms ease, opacity 200ms ease;
    }
    button:active{ transform: scale(.98); }
    .yesBtn{ background: rgba(15,15,18,.92); color:#fff; }
    .noBtn{ background: rgba(255,255,255,.9); color: rgba(12,12,16,.92); }

    .enterBtn{
      margin-top: 14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: rgba(15,15,18,.92);
      color:#fff;
      opacity: 0;
      transform: translateY(6px);
      pointer-events:none;
      transition: opacity 400ms ease, transform 400ms ease;
    }
    .enterBtn.show{
      opacity: 1;
      transform: translateY(0);
      pointer-events:auto;
    }

    /* Fade out modal on enter */
    .modalWrap.fadeOut{
      opacity:0;
      pointer-events:none;
      transition: opacity 900ms ease;
    }

    /* NO button shake */
    @keyframes nudge {
      0%{ transform: translateX(0); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
      100%{ transform: translateX(0); }
    }
    .noBtn.nudge{
      animation: nudge 380ms ease;
    }

    /* Player */
    .playerWrap{
      position:fixed;
      left: 50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      width: min(980px, 92vw);
      z-index: 30;
      pointer-events:auto;
    }

    .player{
      border-radius: 20px;
      background: rgba(18,18,24,.42);
      backdrop-filter: blur(14px) saturate(1.25);
      -webkit-backdrop-filter: blur(14px) saturate(1.25);
      box-shadow: 0 20px 70px rgba(0,0,0,.40);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }

    .playerHeader{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 14px 16px 10px;
    }

    .titleBlock{
      min-width: 0;
    }
    .titleLine{
      display:flex;
      gap: 10px;
      align-items:center;
      font-weight: 800;
      color: rgba(255,255,255,.92);
      line-height: 1.1;
    }
    .subtitle{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-shrink:0;
    }
    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
      transition: transform 140ms ease, box-shadow 250ms ease;
    }
    .iconBtn.on{
      background: rgba(255, 120, 170, .18);
      border-color: rgba(255, 120, 170, .30);
      box-shadow: 0 0 18px rgba(255,120,170,.25);
    }
    .iconBtn:hover{ background: rgba(255,255,255,.10); }
    .iconBtn.on:hover{ background: rgba(255, 120, 170, .22); }

    /* Heart pop */
    .iconBtn.pop{
      transform: scale(1.12);
    }

    .marquee{
      display:none;
      max-width: min(520px, 52vw);
      overflow:hidden;
      white-space: nowrap;
      position:relative;
    }
    .marquee span{
      display:inline-block;
      padding-left: 100%;
      animation: marquee 12s linear infinite;
      opacity:.95;
    }
    @keyframes marquee{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }

    .scrubRow{
      padding: 0 16px 10px;
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(255,255,255,.70);
      font-size: 12px;
    }
    input[type="range"]{
      width: 100%;
      accent-color: var(--accent);
    }

    .controlsRow{
      padding: 0 16px 14px;
      display:flex;
      align-items:center;
      justify-content: center;
      gap: 14px;
    }
    .bigPlay{
      width: 54px; height: 54px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      display:grid;
      place-items:center;
      cursor:pointer;
      border: 0;
    }
    .smallCtrl{
      width: 42px; height: 42px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      display:grid;
      place-items:center;
      cursor:pointer;
      color: rgba(255,255,255,.92);
    }

    .playlist{
      border-top: 1px solid rgba(255,255,255,.10);
      padding: 10px 10px calc(12px + env(safe-area-inset-bottom));
      max-height: 210px;
      overflow:auto;
    }

    .track{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      color: rgba(255,255,255,.90);
    }
    .track:hover{ background: rgba(255,255,255,.06); }
    .track.active{ background: rgba(255, 120, 170, .12); border: 1px solid rgba(255, 120, 170, .18); }
    .trackMeta{
      min-width:0;
    }
    .trackName{
      font-weight: 750;
      font-size: 14px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .trackArtist{
      font-size: 12px;
      color: rgba(255,255,255,.68);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }
    .trackDur{
      font-size: 12px;
      color: rgba(255,255,255,.62);
      flex-shrink:0;
    }

    /* Collapsible player */
    .player.collapsed .scrubRow,
    .player.collapsed .controlsRow,
    .player.collapsed .playlist{
      display:none;
    }
    .collapseCaret{
      width: 34px; height: 34px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
    }

    /* Moon secret message */
    #moonHotspot{
      position: fixed;
      top: 6vh;
      left: 22vw;              /* aligns with moon on most layouts; tweak if needed */
      width: 160px;
      height: 160px;
      border-radius: 50%;
      z-index: 6;
      cursor: pointer;
      background: transparent;
    }

    #moonMessage{
      position: fixed;
      top: 18vh;
      left: 50%;
      transform: translateX(-50%) scale(.96);
      padding: 14px 22px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      color: rgba(20,20,24,.95);
      font-weight: 700;
      font-size: 15px;
      box-shadow: 0 14px 40px rgba(0,0,0,.35);
      opacity: 0;
      pointer-events: none;
      transition: opacity 600ms ease, transform 600ms ease;
      z-index: 25;
    }
    #moonMessage.show{
      opacity: 1;
      transform: translateX(-50%) scale(1);
    }

    /* Mobile tweaks */
    @media (max-width: 520px){
      .cardInner{ padding: 26px 20px 18px; }
      .p{ font-size: 16px; }
      .ask{ font-size: 18px; }
      .marquee{ max-width: 58vw; }
      .playlist{ max-height: 180px; }
      #moonHotspot{
        top: 7vh;
        left: 20vw;
        width: 140px;
        height: 140px;
      }
    }

    /* Reduced motion support */
    @media (prefers-reduced-motion: reduce){
      .cloud{ animation: none !important; }
      .marquee span{ animation: none !important; padding-left: 0 !important; }
      .tagline, .tint, .modalWrap.fadeOut{ transition: none !important; }
    }
  </style>
</head>
<body>
  <div class="scene" aria-hidden="true"></div>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div class="clouds" id="clouds" aria-hidden="true"></div>
  <div class="tint" id="tint" aria-hidden="true"></div>

  <div class="tagline" id="tagline">I wanted to give you something you could stay in.</div>

  <!-- Moon secret -->
  <div id="moonHotspot" role="button" tabindex="0" aria-label="Moon"></div>
  <div id="moonMessage" aria-live="polite">You are the moon to my sun! üåùüíï</div>

  <!-- Ask modal -->
  <div class="modalWrap" id="modal">
    <div class="card cream" id="askCard">
      <div class="cardInner">
        <div class="hello">Hello my love,</div>

        <div class="p">I can‚Äôt believe we are already having our first Valentine‚Äôs Day.</div>
        <div class="p">In a way you have been helping turn my life into a work of art.</div>
        <div class="p">So this is my little ode to you, me, and us.</div>
        <div class="p">Thank you for being my <b>Muse</b>!</div>

        <div class="sig">‚Äî Love Sweets üç≠<small>V.D 2026</small></div>

        <div class="askRow">
          <div class="ask">Will you be my Valentine? üíû</div>
          <div class="btns">
            <button class="yesBtn" id="yesBtn">Yes</button>
            <button class="noBtn" id="noBtn">No</button>
          </div>
        </div>

        <button class="enterBtn" id="enterBtn">Enter the painting ‚ú®</button>
      </div>
    </div>
  </div>

  <!-- Player -->
  <div class="playerWrap" id="playerWrap" style="display:none;">
    <div class="player" id="player">
      <div class="playerHeader">
        <div class="titleBlock">
          <div class="titleLine">
            <div id="staticTitle">To My Everything üíó</div>
            <div class="marquee" id="marquee"><span id="marqueeText"></span></div>
          </div>
          <div class="subtitle" id="subtitle">V.D 2026 playlist</div>
        </div>

        <div class="actions">
          <div class="iconBtn" id="shuffleBtn" title="Shuffle" aria-label="Shuffle">üîÄ</div>
          <div class="iconBtn" id="repeatBtn" title="Repeat" aria-label="Repeat">üîÅ</div>
          <div class="iconBtn" id="heartBtn" title="Love" aria-label="Love">‚ô°</div>
          <div class="collapseCaret" id="collapseBtn" title="Collapse" aria-label="Collapse">‚ñæ</div>
        </div>
      </div>

      <div class="scrubRow">
        <div id="curTime">0:00</div>
        <input id="scrub" type="range" min="0" max="100" value="0" aria-label="Scrub" />
        <div id="durTime">0:00</div>
      </div>

      <div class="controlsRow">
        <div class="smallCtrl" id="prevBtn" title="Previous" aria-label="Previous">‚èÆ</div>
        <button class="bigPlay" id="playBtn" title="Play/Pause" aria-label="Play/Pause">‚ñ∂</button>
        <div class="smallCtrl" id="nextBtn" title="Next" aria-label="Next">‚è≠</div>
      </div>

      <div class="playlist" id="playlist"></div>
    </div>

    <audio id="audio" preload="metadata"></audio>
  </div>

  <script>
    /********************
     * Feature flags (easy rollback switches)
     ********************/
    const FEATURES = {
      moonMessage: true,
      heartPinkShootingStar: true,
      heartPop: true,
      rememberSettings: true,
      reducedMotionRespect: true,
      safeNoButton: true,
      marqueeOnlyIfOverflow: true
    };

    const prefersReducedMotion = window.matchMedia && window.matchMedia("(prefers-reduced-motion: reduce)").matches;

    /********************
     * STATE / PLAYLIST
     ********************/
    const tracks = [
      { file: "everything.mp3", title: "Everything", artist: "Gotts Street Park feat. Rosie Lowe", dur: "3:26" },
      { file: "POV.mp3", title: "pov", artist: "Ariana Grande", dur: "3:22" },
      { file: "IIHANDS.mp3", title: "II HANDS II HEAVEN", artist: "Beyonc√©", dur: "4:??" },
      { file: "Sweet.mp3", title: "Sweet Love", artist: "Anita Baker", dur: "4:??" },
      { file: "OurLove.mp3", title: "Our Love", artist: "Curtis Harding & Jazmine Sullivan", dur: "3:??" },
      { file: "Floating.mp3", title: "Floating", artist: "Alina", dur: "3:??" },
      { file: "All.mp3", title: "All In", artist: "Desiree Dawson", dur: "3:??" },
      { file: "End.mp3", title: "End of the Night", artist: "Kenny G", dur: "5:??" },
      { file: "Myone.mp3", title: "My One and Only Love", artist: "John Coltrane", dur: "7:??" },
      { file: "Ribbon.mp3", title: "Ribbon in the Sky", artist: "Stevie Wonder", dur: "5:37" },
      { file: "Nothing.mp3", title: "Nothing Even Matters", artist: "Lauryn Hill", dur: "5:50" },
    ];

    let accepted = false;
    let currentIndex = 0;
    let isShuffle = false;
    let isRepeat = false;
    let liked = false;

    // Build a play order for shuffle
    let order = tracks.map((_, i) => i);

    // Transition guard
    let transitioning = false;

    const modal = document.getElementById("modal");
    const askCard = document.getElementById("askCard");
    const yesBtn = document.getElementById("yesBtn");
    const noBtn = document.getElementById("noBtn");
    const enterBtn = document.getElementById("enterBtn");

    const tint = document.getElementById("tint");
    const tagline = document.getElementById("tagline");

    const playerWrap = document.getElementById("playerWrap");
    const player = document.getElementById("player");
    const playlistEl = document.getElementById("playlist");

    const audio = document.getElementById("audio");
    const playBtn = document.getElementById("playBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const scrub = document.getElementById("scrub");
    const curTime = document.getElementById("curTime");
    const durTime = document.getElementById("durTime");

    const shuffleBtn = document.getElementById("shuffleBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const heartBtn = document.getElementById("heartBtn");
    const collapseBtn = document.getElementById("collapseBtn");

    const staticTitle = document.getElementById("staticTitle");
    const marquee = document.getElementById("marquee");
    const marqueeText = document.getElementById("marqueeText");

    const moonHotspot = document.getElementById("moonHotspot");
    const moonMessage = document.getElementById("moonMessage");

    const LS_KEY = "paintedValentine_v1";

    function saveState(){
      if (!FEATURES.rememberSettings) return;
      const payload = {
        isShuffle, isRepeat, liked,
        collapsed: player.classList.contains("collapsed")
      };
      try{ localStorage.setItem(LS_KEY, JSON.stringify(payload)); }catch(e){}
    }

    function loadState(){
      if (!FEATURES.rememberSettings) return;
      try{
        const raw = localStorage.getItem(LS_KEY);
        if (!raw) return;
        const s = JSON.parse(raw);
        isShuffle = !!s.isShuffle;
        isRepeat = !!s.isRepeat;
        liked = !!s.liked;

        shuffleBtn.classList.toggle("on", isShuffle);
        repeatBtn.classList.toggle("on", isRepeat);
        heartBtn.classList.toggle("on", liked);
        heartBtn.textContent = liked ? "‚ô•" : "‚ô°";

        if (s.collapsed){
          player.classList.add("collapsed");
          collapseBtn.textContent = "‚ñ¥";
        }
      }catch(e){}
    }

    function fmtTime(sec){
      if (!isFinite(sec)) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function rebuildOrder(){
      order = tracks.map((_, i) => i);
      if (isShuffle){
        for (let i = order.length - 1; i > 0; i--){
          const j = Math.floor(Math.random() * (i + 1));
          [order[i], order[j]] = [order[j], order[i]];
        }
      }
    }

    function getOrderedIndex(){
      return order.indexOf(currentIndex);
    }

    function shouldUseMarquee(text){
      if (!FEATURES.marqueeOnlyIfOverflow) return true;
      // Temporarily set text and measure overflow
      marqueeText.textContent = text;
      marquee.style.display = "block";
      const span = marqueeText;
      // allow layout
      const overflow = span.scrollWidth > marquee.clientWidth + 6;
      return overflow;
    }

    function setTitleForState(){
      const isPlaying = !audio.paused && audio.currentTime > 0;
      if (!isPlaying){
        staticTitle.style.display = "block";
        marquee.style.display = "none";
        marqueeText.textContent = "";
        return;
      }

      const t = tracks[currentIndex];
      const text = `${t.title} ‚Äî ${t.artist}`;

      staticTitle.style.display = "none";

      if (prefersReducedMotion && FEATURES.reducedMotionRespect){
        marquee.style.display = "none";
        staticTitle.style.display = "block";
        staticTitle.textContent = text; // readable, non-moving
        return;
      }

      const use = shouldUseMarquee(text);
      if (use){
        marquee.style.display = "block";
        marqueeText.textContent = text;
      }else{
        marquee.style.display = "none";
        staticTitle.style.display = "block";
        staticTitle.textContent = text;
      }
    }

    function loadTrack(idx, autoplay=false){
      currentIndex = idx;
      audio.src = tracks[idx].file;
      audio.load();
      highlightActive();
      setTitleForState();
      if (autoplay){
        audio.play().catch(()=>{});
      }
    }

    function highlightActive(){
      [...playlistEl.querySelectorAll(".track")].forEach((row)=>{
        const rowIdx = Number(row.dataset.index);
        row.classList.toggle("active", rowIdx === currentIndex);
      });
    }

    function nextTrack(){
      const pos = getOrderedIndex();
      const nextPos = (pos + 1) % order.length;
      loadTrack(order[nextPos], true);
    }

    function prevTrack(){
      const pos = getOrderedIndex();
      const prevPos = (pos - 1 + order.length) % order.length;
      loadTrack(order[prevPos], true);
    }

    function buildPlaylist(){
      playlistEl.innerHTML = "";
      tracks.forEach((t, i)=>{
        const row = document.createElement("div");
        row.className = "track";
        row.dataset.index = String(i);
        row.innerHTML = `
          <div class="trackMeta">
            <div class="trackName">${t.title}</div>
            <div class="trackArtist">${t.artist}</div>
          </div>
          <div class="trackDur">${t.dur}</div>
        `;
        row.addEventListener("click", ()=>{
          loadTrack(i, true);
        });
        playlistEl.appendChild(row);
      });
      highlightActive();
    }

    /********************
     * ASK FLOW
     ********************/
    yesBtn.addEventListener("click", ()=>{
      if (transitioning) return;
      // show Enter, fade IN tagline
      enterBtn.classList.add("show");
      tagline.classList.add("show");
    });

    noBtn.addEventListener("click", ()=>{
      if (!FEATURES.safeNoButton) return;

      // playful refusal
      noBtn.classList.remove("nudge");
      void noBtn.offsetWidth; // restart animation
      noBtn.classList.add("nudge");

      const original = noBtn.textContent;
      noBtn.textContent = "Nice try üòå";
      setTimeout(()=>{ noBtn.textContent = original; }, 900);
    });

    enterBtn.addEventListener("click", ()=>{
      if (transitioning) return;
      transitioning = true;
      accepted = true;

      // Fade away the card + tint + tagline
      modal.classList.add("fadeOut");
      tint.classList.add("off");
      tagline.classList.add("fade");

      // Show player once we enter
      playerWrap.style.display = "block";

      rebuildOrder();
      loadTrack(currentIndex, false);

      setTimeout(()=>{
        modal.style.display = "none";
        transitioning = false;
      }, 1000);
    });

    /********************
     * MOON SECRET
     ********************/
    let moonRevealed = false;

    function revealMoonMessage(){
      if (!FEATURES.moonMessage) return;
      if (moonRevealed) return;
      moonRevealed = true;
      moonMessage.classList.add("show");
      setTimeout(()=> moonMessage.classList.remove("show"), 4200);
    }

    moonHotspot.addEventListener("click", revealMoonMessage);
    moonHotspot.addEventListener("keydown", (e)=>{
      if (e.key === "Enter" || e.key === " "){
        e.preventDefault();
        revealMoonMessage();
      }
    });

    /********************
     * PLAYER CONTROLS
     ********************/
    playBtn.addEventListener("click", async ()=>{
      if (audio.src === "" || audio.src.endsWith("/")){
        loadTrack(currentIndex, false);
      }
      if (audio.paused){
        try{
          await audio.play();
          playBtn.textContent = "‚è∏";
        }catch(e){}
      }else{
        audio.pause();
        playBtn.textContent = "‚ñ∂";
      }
      setTitleForState();
    });

    prevBtn.addEventListener("click", prevTrack);
    nextBtn.addEventListener("click", nextTrack);

    shuffleBtn.addEventListener("click", ()=>{
      isShuffle = !isShuffle;
      shuffleBtn.classList.toggle("on", isShuffle);
      rebuildOrder();
      saveState();
    });

    repeatBtn.addEventListener("click", ()=>{
      isRepeat = !isRepeat;
      repeatBtn.classList.toggle("on", isRepeat);
      saveState();
    });

    // Heart: pop + pink shooting star trigger
    heartBtn.addEventListener("click", ()=>{
      liked = !liked;
      heartBtn.textContent = liked ? "‚ô•" : "‚ô°";
      heartBtn.classList.toggle("on", liked);

      if (FEATURES.heartPop){
        heartBtn.classList.add("pop");
        setTimeout(()=>heartBtn.classList.remove("pop"), 180);
      }

      if (FEATURES.heartPinkShootingStar && liked){
        spawnSpecialShootingStar("pink");
      }

      saveState();
    });

    collapseBtn.addEventListener("click", ()=>{
      const collapsed = player.classList.toggle("collapsed");
      collapseBtn.textContent = collapsed ? "‚ñ¥" : "‚ñæ";
      saveState();
    });

    audio.addEventListener("timeupdate", ()=>{
      if (!isFinite(audio.duration) || audio.duration <= 0) return;
      scrub.value = String((audio.currentTime / audio.duration) * 100);
      curTime.textContent = fmtTime(audio.currentTime);
    });

    audio.addEventListener("loadedmetadata", ()=>{
      durTime.textContent = fmtTime(audio.duration);
      curTime.textContent = fmtTime(0);
      scrub.value = "0";
    });

    audio.addEventListener("play", ()=>{
      playBtn.textContent = "‚è∏";
      setTitleForState();
    });

    audio.addEventListener("pause", ()=>{
      playBtn.textContent = "‚ñ∂";
      setTitleForState();
    });

    audio.addEventListener("ended", ()=>{
      if (isRepeat){
        audio.currentTime = 0;
        audio.play().catch(()=>{});
        return;
      }
      nextTrack();
    });

    scrub.addEventListener("input", ()=>{
      if (!isFinite(audio.duration) || audio.duration <= 0) return;
      const pct = Number(scrub.value) / 100;
      audio.currentTime = pct * audio.duration;
    });

    /********************
     * CLOUDS (unchanged)
     ********************/
    const cloudsEl = document.getElementById("clouds");
    function rand(min, max){ return Math.random() * (max - min) + min; }

    function spawnCloud(layerClass){
      const img = document.createElement("img");
      img.src = "cloud.png";
      img.className = `cloud ${layerClass}`;

      const scale = rand(0.85, 1.35);
      const opacity = layerClass === "layer1" ? rand(.36, .48)
                    : layerClass === "layer2" ? rand(.24, .34)
                    : rand(.18, .28);

      const dur = rand(
        parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--cloudMinDur")) || 90,
        parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--cloudMaxDur")) || 120
      );

      const delay = rand(0, 18);
      img.style.setProperty("--y", `${rand(-6, 14)}px`);
      img.style.setProperty("--s", `${scale}`);
      img.style.setProperty("--o", `${opacity}`);

      // Respect reduced motion
      if (!(prefersReducedMotion && FEATURES.reducedMotionRespect)){
        img.style.animation = `drift ${dur}s linear ${delay}s infinite`;
      }else{
        img.style.animation = "none";
      }

      img.style.width = `${rand(380, 720)}px`;

      cloudsEl.appendChild(img);
      return img;
    }

    function initClouds(){
      cloudsEl.innerHTML = "";
      const counts = { layer1: 3, layer2: 3, layer3: 2 };
      Object.entries(counts).forEach(([layer, count])=>{
        for (let i=0; i<count; i++) spawnCloud(layer);
      });
    }

    /********************
     * STARS + SHOOTING STARS
     ********************/
    const canvas = document.getElementById("stars");
    const ctx = canvas.getContext("2d");

    let W=0, H=0;
    function resize(){
      W = canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
      H = canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      buildStars();
    }
    window.addEventListener("resize", resize);

    let stars = [];
    function buildStars(){
      stars = [];
      const count = Math.floor((window.innerWidth * window.innerHeight) / 9000);
      for (let i=0; i<count; i++){
        stars.push({
          x: Math.random() * W,
          y: Math.random() * H * 0.62,
          r: rand(0.6, 1.7) * devicePixelRatio,
          a: rand(0.15, 0.9),
          tw: prefersReducedMotion && FEATURES.reducedMotionRespect ? rand(0.0005, 0.002) : rand(0.002, 0.01),
          phase: rand(0, Math.PI*2)
        });
      }
    }

    let shooting = null;

    function spawnSpecialShootingStar(color){
      if (shooting) return; // avoid stacking
      shooting = {
        x: rand(W*0.15, W*0.85),
        y: rand(H*0.06, H*0.32),
        vx: rand(8, 12) * devicePixelRatio,
        vy: rand(3, 6) * devicePixelRatio,
        life: 0,
        max: rand(40, 58),
        color
      };
    }

    function maybeSpawnShootingStar(){
      if (shooting) return;
      if (prefersReducedMotion && FEATURES.reducedMotionRespect) return;
      if (Math.random() < 0.006){
        shooting = {
          x: rand(W*0.15, W*0.85),
          y: rand(H*0.05, H*0.35),
          vx: rand(10, 16) * devicePixelRatio,
          vy: rand(4, 7) * devicePixelRatio,
          life: 0,
          max: rand(26, 40),
          color: null
        };
      }
    }

    function draw(){
      ctx.clearRect(0,0,W,H);

      // Stars (twinkle)
      for (const s of stars){
        s.phase += s.tw;
        const tw = (Math.sin(s.phase) + 1) / 2;
        const alpha = Math.min(1, Math.max(0, s.a * (0.6 + tw*0.6)));
        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${alpha})`;
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
      }

      // Shooting star
      maybeSpawnShootingStar();
      if (shooting){
        shooting.life += 1;
        const t = shooting.life / shooting.max;

        const x1 = shooting.x + shooting.vx * shooting.life;
        const y1 = shooting.y + shooting.vy * shooting.life;

        const tailLen = 120 * devicePixelRatio;
        const dx = shooting.vx, dy = shooting.vy;
        const mag = Math.sqrt(dx*dx + dy*dy) || 1;
        const tx = (dx / mag) * tailLen;
        const ty = (dy / mag) * tailLen;

        const a = (1 - t) * 0.9;

        const starColor = shooting.color;
        const stroke =
          starColor === "pink"
            ? `rgba(255,160,200,${a})`
            : `rgba(255,255,255,${a})`;

        ctx.strokeStyle = stroke;
        ctx.lineWidth = starColor ? 3.2 * devicePixelRatio : 2.2 * devicePixelRatio;

        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x1 - tx, y1 - ty);
        ctx.stroke();

        ctx.fillStyle = stroke;
        ctx.beginPath();
        ctx.arc(x1, y1, (starColor ? 2.8 : 2.2) * devicePixelRatio, 0, Math.PI*2);
        ctx.fill();

        if (shooting.life >= shooting.max) shooting = null;
      }

      requestAnimationFrame(draw);
    }

    /********************
     * INIT
     ********************/
    buildPlaylist();
    initClouds();
    resize();
    draw();

    // Restore persisted toggles
    loadState();

    // Start with first track loaded (no autoplay)
    rebuildOrder();
    loadTrack(0, false);
    setTitleForState();
  </script>
</body>
</html>