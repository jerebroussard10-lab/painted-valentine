<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Painted Valentine</title>
  <style>
    :root{
      --glass: rgba(25, 25, 30, 0.35);
      --glass-strong: rgba(10, 10, 14, 0.60);
      --card-cream: #f6efe1;
      --card-cream-2: #efe5d2;
      --ink: #151515;
      --pink: #ff77b7;
      --pink-soft: #ff9fcd;
      --shadow: 0 18px 60px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius-lg: 22px;
      --ui: rgba(255,255,255,0.12);
      --ui2: rgba(255,255,255,0.18);
      --ui3: rgba(255,255,255,0.24);
      --text: rgba(255,255,255,0.92);
      --text-dim: rgba(255,255,255,0.68);
      --treeline-y: 56%; /* clouds sit above this */
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:#07070b;
      overflow:hidden;
      color:var(--text);
    }

    /* Scene */
    .scene{
      position:relative;
      width:100%;
      height:100%;
      overflow:hidden;
      background:#07070b;
    }

    .bg{
      position:absolute;
      inset:0;
      background: url("Midnight.png") center/cover no-repeat;
      transform: scale(1.03);
      filter: saturate(1.05) contrast(1.02);
      will-change: filter, transform;
    }

    /* ‚ÄúTinted glass‚Äù before YES */
    .glassTint{
      position:absolute;
      inset:0;
      background: rgba(5, 8, 14, 0.55);
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
      transition: opacity 900ms ease;
      opacity:1;
    }
    .entered .glassTint{ opacity:0; pointer-events:none; }

    /* Stars behind clouds (subtle) */
    .stars{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity: 0.0;
      transition: opacity 900ms ease;
      background:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,.6), transparent 45%),
        radial-gradient(1px 1px at 40% 35%, rgba(255,255,255,.4), transparent 45%),
        radial-gradient(1px 1px at 75% 30%, rgba(255,255,255,.5), transparent 45%),
        radial-gradient(1px 1px at 60% 15%, rgba(255,255,255,.35), transparent 45%),
        radial-gradient(1px 1px at 90% 40%, rgba(255,255,255,.5), transparent 45%),
        radial-gradient(1px 1px at 25% 55%, rgba(255,255,255,.25), transparent 45%),
        radial-gradient(1px 1px at 55% 65%, rgba(255,255,255,.25), transparent 45%),
        radial-gradient(1px 1px at 85% 70%, rgba(255,255,255,.2), transparent 45%);
      animation: starTwinkle 4.2s ease-in-out infinite;
      mix-blend-mode: screen;
    }
    .entered .stars{ opacity:0.35; }

    @keyframes starTwinkle{
      0%,100%{ filter: brightness(0.95); opacity:0.28; }
      50%{ filter: brightness(1.15); opacity:0.40; }
    }

    /* Clouds layer */
    .cloudLayer{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity 900ms ease;
    }
    .entered .cloudLayer{ opacity:1; }

    .cloud{
      position:absolute;
      width: min(55vw, 720px);
      height:auto;
      left:-60%;
      top: calc(var(--treeline-y) - 12%);
      transform: translate3d(0,0,0) scale(var(--scale));
      opacity: var(--opacity);
      filter: blur(0.2px) saturate(0.95) brightness(1.05);
      will-change: transform, opacity;
      animation: drift var(--dur) linear infinite;
      animation-delay: var(--delay);
      mask-image: radial-gradient(circle at 50% 50%, rgba(0,0,0,1), rgba(0,0,0,1) 70%, rgba(0,0,0,0) 100%);
    }

    /* drift fully across + fade edges (no reverse) */
    @keyframes drift{
      0%   { transform: translate3d(-45vw,0,0) scale(var(--scale)); opacity:0; }
      8%   { opacity: var(--opacity); }
      92%  { opacity: var(--opacity); }
      100% { transform: translate3d(160vw,0,0) scale(var(--scale)); opacity:0; }
    }

    /* Fireflies */
    .flies{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;
      transition: opacity 900ms ease;
    }
    .entered .flies{ opacity:1; }

    .fly{
      position:absolute;
      width: 6px;
      height: 6px;
      border-radius:999px;
      background: rgba(255, 214, 120, 0.95);
      box-shadow:
        0 0 10px rgba(255, 214, 120, 0.85),
        0 0 24px rgba(255, 214, 120, 0.55);
      opacity: 0.0;
      animation:
        flyFloat var(--fDur) ease-in-out infinite,
        flyGlow var(--gDur) ease-in-out infinite;
      animation-delay: var(--d);
      will-change: transform, opacity, filter;
      mix-blend-mode: screen;
    }

    @keyframes flyGlow{
      0%,100%{ opacity:0.15; filter: brightness(0.85); }
      50%{ opacity:0.95; filter: brightness(1.25); }
    }
    @keyframes flyFloat{
      0%,100%{ transform: translate3d(0,0,0); }
      50%{ transform: translate3d(var(--dx), var(--dy), 0); }
    }

    /* Top italic line */
    .topLine{
      position:absolute;
      top: 7.5vh;
      width:100%;
      text-align:center;
      font-style: italic;
      color: rgba(255,255,255,0.86);
      text-shadow: 0 8px 30px rgba(0,0,0,0.35);
      letter-spacing: 0.2px;
      padding: 0 16px;
      opacity: 0;
      transform: translateY(-8px);
      transition: opacity 800ms ease, transform 800ms ease;
      pointer-events:none;
      z-index: 20;
    }
    .overlayActive .topLine{
      opacity: 1;
      transform: translateY(0);
      animation: topFadeOut 6s ease forwards;
      animation-delay: 1.6s;
    }
    @keyframes topFadeOut{
      to{ opacity:0; transform: translateY(-10px); }
    }

    /* Overlay card */
    .overlay{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
      z-index: 30;
      transition: opacity 700ms ease, transform 700ms ease;
    }
    .overlay.hidden{
      opacity:0;
      pointer-events:none;
      transform: translateY(10px);
    }

    .card{
      width: min(860px, 95vw);
      background: linear-gradient(180deg, var(--card-cream), var(--card-cream-2));
      color: var(--ink);
      border-radius: var(--radius-lg);
      box-shadow: var(--shadow);
      padding: 26px 30px;
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(1000px 400px at 10% 10%, rgba(255,255,255,0.35), transparent 60%),
        radial-gradient(900px 500px at 90% 30%, rgba(255,255,255,0.26), transparent 55%),
        repeating-linear-gradient(0deg, rgba(0,0,0,0.015), rgba(0,0,0,0.015) 1px, transparent 1px, transparent 5px);
      opacity:0.55;
      pointer-events:none;
      mix-blend-mode: multiply;
    }

    .card h2{
      margin:0 0 10px 0;
      font-size: 20px;
      line-height: 1.2;
    }
    .card p{
      margin: 8px 0;
      font-size: 16px;
      line-height: 1.55;
    }
    .sig{
      margin-top: 16px;
      font-weight: 600;
    }
    .small{
      font-size: 13px;
      opacity: 0.75;
      margin-top: 4px;
    }

    .askRow{
      margin-top: 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      flex-wrap: wrap;
    }
    .askText{
      font-weight: 700;
      font-size: 18px;
    }

    .btnRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .btn{
      border:0;
      border-radius:999px;
      padding: 10px 18px;
      cursor:pointer;
      font-weight: 700;
      transition: transform 120ms ease, filter 120ms ease, background 200ms ease;
      box-shadow: 0 10px 24px rgba(0,0,0,0.20);
    }
    .btn:active{ transform: scale(0.98); }
    .btnYes{
      background: #171717;
      color: #fff;
    }
    .btnNo{
      background: #fff;
      color: #111;
    }

    /* No-state card */
    .card.noState{
      background: linear-gradient(135deg, rgba(18,18,18,0.92), rgba(8,8,10,0.92));
      color: rgba(255,255,255,0.92);
    }
    .card.noState::before{ opacity:0.18; mix-blend-mode: screen; }
    .sadWrap{
      margin-top: 18px;
      height: 120px;
      display:flex;
      align-items:center;
      justify-content:center;
    }
    .sadEmoji{
      font-size: 56px; /* bigger & centered */
      filter: drop-shadow(0 12px 30px rgba(0,0,0,0.35));
    }
    .resetBtn{
      margin-top: 14px;
      background: rgba(255,255,255,0.9);
      color:#111;
      border:0;
      border-radius:999px;
      padding: 9px 16px;
      font-weight: 800;
      cursor:pointer;
      width: fit-content;
    }

    /* Player */
    .playerWrap{
      position:absolute;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%);
      width: min(980px, calc(100vw - 24px));
      z-index: 25;
      opacity: 0;
      pointer-events:none;
      transition: opacity 900ms ease, transform 900ms ease;
    }
    .entered .playerWrap{
      opacity:1;
      pointer-events:auto;
      transform: translateX(-50%) translateY(0);
    }

    .player{
      background: rgba(20, 20, 26, 0.46);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 20px;
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      box-shadow: 0 18px 60px rgba(0,0,0,0.35);
      overflow:hidden;
    }

    .playerTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px 10px 16px;
      gap: 12px;
    }

    .titleBlock{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .line1{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .nowTitle{
      font-weight: 800;
      font-size: 15px;
      letter-spacing: 0.2px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      max-width: 52vw;
    }
    .subTitle{
      font-size: 12px;
      color: var(--text-dim);
    }

    /* marquee only when playing */
    .marquee{
      position:relative;
      overflow:hidden;
    }
    .marquee .marqueeInner{
      display:inline-block;
      padding-left: 0;
      transform: translateX(0);
    }
    .marquee.playing .marqueeInner{
      padding-left: 0;
      animation: marquee 11s linear infinite;
    }
    @keyframes marquee{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-55%); }
    }

    .controlsRight{
      display:flex;
      align-items:center;
      gap: 10px;
    }

    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.06);
      color: rgba(255,255,255,0.9);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: background 160ms ease, transform 120ms ease;
      user-select:none;
    }
    .iconBtn:hover{ background: rgba(255,255,255,0.10); }
    .iconBtn:active{ transform: scale(0.98); }
    .iconBtn.on{ background: rgba(255,255,255,0.16); border-color: rgba(255,255,255,0.18); }

    .progressRow{
      padding: 0 16px 10px 16px;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    .bar{
      height: 8px;
      border-radius: 999px;
      background: rgba(255,255,255,0.10);
      position:relative;
      cursor:pointer;
      overflow:hidden;
    }
    .barFill{
      position:absolute;
      left:0; top:0; bottom:0;
      width: 0%;
      background: rgba(255,255,255,0.78);
      border-radius: 999px;
    }
    .timeRow{
      display:flex;
      justify-content:space-between;
      font-size: 12px;
      color: rgba(255,255,255,0.75);
    }

    /* Center transport controls */
    .transportRow{
      padding: 0 16px 14px 16px;
      display:grid;
      grid-template-columns: 1fr auto 1fr;
      align-items:center;
      gap: 10px;
    }
    .transportCenter{
      display:flex;
      align-items:center;
      justify-content:center;
      gap: 14px;
    }
    .roundBtn{
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.10);
      cursor:pointer;
      display:grid;
      place-items:center;
      transition: transform 120ms ease, background 180ms ease;
    }
    .roundBtn:active{ transform: scale(0.98); }
    .roundBtn.primary{
      width: 62px;
      height: 62px;
      background: rgba(255,255,255,0.92);
      color:#111;
      border-color: rgba(255,255,255,0.45);
    }

    .transportLeft, .transportRight{
      display:flex;
      align-items:center;
      gap: 10px;
    }
    .transportLeft{ justify-content:flex-start; }
    .transportRight{ justify-content:flex-end; }

    /* Playlist drawer */
    .drawer{
      border-top: 1px solid rgba(255,255,255,0.10);
      max-height: 0px;
      overflow:hidden;
      transition: max-height 380ms ease;
    }
    .player.open .drawer{
      max-height: 320px;
    }
    .list{
      padding: 12px 12px 16px 12px; /* extra bottom so it doesn‚Äôt cut */
      max-height: 320px;
      overflow:auto;
    }
    .track{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.06);
      margin-bottom: 10px;
      transition: background 160ms ease, border-color 160ms ease;
    }
    .track:hover{ background: rgba(255,255,255,0.06); }
    .track.active{
      background: rgba(255, 140, 196, 0.14);
      border-color: rgba(255, 140, 196, 0.26);
    }
    .trackLeft{
      min-width:0;
      display:flex;
      flex-direction:column;
    }
    .tName{
      font-weight: 800;
      font-size: 13px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 68vw;
    }
    .tArtist{
      font-size: 12px;
      color: rgba(255,255,255,0.68);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 68vw;
    }
    .tRight{
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(255,255,255,0.70);
      font-size: 12px;
      flex-shrink:0;
    }
    .miniHeart{
      opacity: 0.85;
    }

    /* Collapse for mobile */
    @media (max-width: 640px){
      .nowTitle{ max-width: 54vw; }
      .player.open .drawer{ max-height: 260px; }
      .playerWrap{ bottom: 10px; }
      .card{ padding: 22px 18px; }
      .card p{ font-size: 15px; }
      .sadWrap{ height: 110px; }
      .sadEmoji{ font-size: 62px; }
    }

    /* Debug */
    .debug{
      position:absolute;
      top: 10px;
      left: 10px;
      z-index: 40;
      background: rgba(0,0,0,0.55);
      color: rgba(255,255,255,0.9);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 12px;
      display:none;
      gap: 8px;
      align-items:center;
    }
    .debug.show{ display:flex; }
    .debug button{
      border:0;
      background: rgba(255,255,255,0.12);
      color: rgba(255,255,255,0.92);
      padding: 6px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-weight:700;
    }
  </style>
</head>

<body>
  <div class="scene" id="scene">
    <div class="bg"></div>

    <!-- stars behind clouds -->
    <div class="stars"></div>

    <!-- clouds -->
    <div class="cloudLayer" id="cloudLayer"></div>

    <!-- fireflies -->
    <div class="flies" id="flies"></div>

    <!-- tinted glass -->
    <div class="glassTint"></div>

    <!-- top italic line -->
    <div class="topLine" id="topLine">I wanted to give you something you could stay in.</div>

    <!-- overlay -->
    <div class="overlay overlayActive" id="overlay">
      <div class="card" id="card">
        <h2>Hello my love,</h2>
        <p>I can‚Äôt believe we are already having our first Valentine‚Äôs Day.</p>
        <p>In a way you have been helping turn my life into a work of art.</p>
        <p>So this is my little ode to you, me, and us.</p>
        <p>Thank you for being my <b>Muse</b>!</p>

        <p class="sig">‚Äì Love Sweets üç≠</p>
        <div class="small">V.D 2026</div>

        <div class="askRow" id="askRow">
          <div class="askText">Will you be my Valentine? üíñ</div>
          <div class="btnRow">
            <button class="btn btnYes" id="yesBtn">Yes</button>
            <button class="btn btnNo" id="noBtn">No</button>
          </div>
        </div>

        <!-- NO-state content injected here -->
        <div id="noStateMount"></div>
      </div>
    </div>

    <!-- player -->
    <div class="playerWrap" id="playerWrap">
      <div class="player" id="player">
        <div class="playerTop">
          <div class="titleBlock">
            <div class="line1">
              <div class="nowTitle marquee" id="titleMarquee">
                <span class="marqueeInner" id="nowTitle">To My Everything üíó</span>
              </div>
            </div>
            <div class="subTitle" id="subTitle">V.D 2026 playlist</div>
          </div>

          <div class="controlsRight">
            <button class="iconBtn" id="shuffleBtn" title="Shuffle">üîÄ</button>
            <button class="iconBtn" id="repeatBtn" title="Repeat">üîÅ</button>
            <button class="iconBtn" id="drawerBtn" title="Playlist">‚ñæ</button>
            <button class="iconBtn" id="heartBtn" title="Like">‚ô°</button>
          </div>
        </div>

        <div class="progressRow">
          <div class="bar" id="bar">
            <div class="barFill" id="barFill"></div>
          </div>
          <div class="timeRow">
            <div id="tCur">0:00</div>
            <div id="tDur">0:00</div>
          </div>
        </div>

        <div class="transportRow">
          <div class="transportLeft"></div>

          <div class="transportCenter">
            <button class="roundBtn" id="prevBtn" title="Previous">‚èÆ</button>
            <button class="roundBtn primary" id="playBtn" title="Play/Pause">‚ñ∂</button>
            <button class="roundBtn" id="nextBtn" title="Next">‚è≠</button>
          </div>

          <div class="transportRight"></div>
        </div>

        <div class="drawer" id="drawer">
          <div class="list" id="list"></div>
        </div>
      </div>
    </div>

    <!-- audio -->
    <audio id="audio" preload="metadata"></audio>

    <!-- debug -->
    <div class="debug" id="debug">
      <span>Debug</span>
      <button id="dbgEnter">Toggle Enter</button>
      <button id="dbgReset">Reset</button>
    </div>
  </div>

  <script>
    // ---------- Helpers ----------
    const $ = (s) => document.querySelector(s);
    const clamp = (n,min,max) => Math.max(min, Math.min(max,n));
    const fmtTime = (sec) => {
      if (!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,"0")}`;
    };

    // ---------- Elements ----------
    const scene = $("#scene");
    const overlay = $("#overlay");
    const card = $("#card");
    const askRow = $("#askRow");
    const noStateMount = $("#noStateMount");
    const topLine = $("#topLine");

    const playerWrap = $("#playerWrap");
    const player = $("#player");
    const drawer = $("#drawer");
    const listEl = $("#list");

    const audio = $("#audio");

    const nowTitleEl = $("#nowTitle");
    const titleMarquee = $("#titleMarquee");
    const subTitleEl = $("#subTitle");

    const shuffleBtn = $("#shuffleBtn");
    const repeatBtn = $("#repeatBtn");
    const drawerBtn = $("#drawerBtn");
    const heartBtn = $("#heartBtn");

    const prevBtn = $("#prevBtn");
    const playBtn = $("#playBtn");
    const nextBtn = $("#nextBtn");

    const bar = $("#bar");
    const barFill = $("#barFill");
    const tCur = $("#tCur");
    const tDur = $("#tDur");

    const cloudLayer = $("#cloudLayer");
    const flies = $("#flies");

    // ---------- Playlist (your files + titles/artists) ----------
    const TRACKS = [
      { file: "everything.mp3", title: "Everything", artist: "Gotts Street Park feat. Rosie Lowe" },
      { file: "POV.mp3",        title: "pov", artist: "Ariana Grande" },
      { file: "IIHANDS.mp3",    title: "II HANDS II HEAVEN", artist: "Beyonc√©" },
      { file: "Sweet.mp3",      title: "Sweet Love", artist: "Anita Baker" },
      { file: "OurLove.mp3",    title: "Our Love", artist: "Curtis Harding & Jazmine Sullivan" },
      { file: "Floating.mp3",   title: "Floating", artist: "Alina Baraz" },
      { file: "All.mp3",        title: "All In", artist: "Desiree Dawson" },
      { file: "End.mp3",        title: "End of the Night", artist: "Kenny G" },
      { file: "Myone.mp3",      title: "My One and Only Love", artist: "John Coltrane" },
      { file: "Ribbon.mp3",     title: "Ribbon in the Sky", artist: "Stevie Wonder" },
      { file: "Nothing.mp3",    title: "Nothing Even Matters", artist: "Lauryn Hill" },
    ];

    // ---------- Player State ----------
    let currentIndex = 0;
    let isShuffle = false;
    // repeatMode: 0=off, 1=all, 2=one
    let repeatMode = 1;
    let entered = false;

    // For shuffle history so prev works nicely
    let history = [];
    // Likes (by file)
    const likes = new Set();

    // ---------- Build Clouds (staggered, above treeline) ----------
    function buildClouds(){
      cloudLayer.innerHTML = "";
      const cloudCount = 6;

      for (let i=0;i<cloudCount;i++){
        const img = document.createElement("img");
        img.src = "cloud.png";
        img.className = "cloud";

        // Keep clouds just above treeline with slight variation
        const y = clamp(42 + Math.random()*10, 40, 52); // %
        const scale = 0.65 + Math.random()*0.55;
        const opacity = 0.26 + Math.random()*0.22;

        // 110‚Äì140s drift feels dreamy
        const dur = (105 + Math.random()*40).toFixed(0) + "s";

        // Stagger; negative delay = already in motion on load
        const delay = (-Math.random()*120).toFixed(1) + "s";

        img.style.top = `calc(${y}% - 60px)`;
        img.style.setProperty("--scale", scale.toFixed(2));
        img.style.setProperty("--opacity", opacity.toFixed(2));
        img.style.setProperty("--dur", dur);
        img.style.setProperty("--delay", delay);

        cloudLayer.appendChild(img);
      }
    }

    // ---------- Build Fireflies (brighter + twinkle) ----------
    function buildFlies(){
      flies.innerHTML = "";
      const n = 26;

      for (let i=0;i<n;i++){
        const f = document.createElement("div");
        f.className = "fly";

        // place mostly lower half (near field/trees)
        const x = Math.random()*100;
        const y = 58 + Math.random()*38; // 58‚Äì96%

        const fDur = 2.8 + Math.random()*4.2; // float
        const gDur = 1.8 + Math.random()*3.2; // glow
        const d = Math.random()*6;

        const dx = (Math.random()*22 - 11).toFixed(1) + "px";
        const dy = (Math.random()*18 - 9).toFixed(1) + "px";

        f.style.left = x + "%";
        f.style.top = y + "%";
        f.style.setProperty("--fDur", fDur.toFixed(2) + "s");
        f.style.setProperty("--gDur", gDur.toFixed(2) + "s");
        f.style.setProperty("--d", d.toFixed(2) + "s");
        f.style.setProperty("--dx", dx);
        f.style.setProperty("--dy", dy);

        flies.appendChild(f);
      }
    }

    // ---------- Overlay / Flow ----------
    function setEntered(v){
      entered = v;
      scene.classList.toggle("entered", entered);
      scene.classList.toggle("overlayActive", !entered);
      if (entered){
        overlay.classList.add("hidden");
      } else {
        overlay.classList.remove("hidden");
        // reset NO state if coming back
        resetNoStateUI();
      }
    }

    function showNoState(){
      // swap to black card, remove ask row, show centered emoji, reset button
      card.classList.add("noState");
      askRow.style.display = "none";

      noStateMount.innerHTML = `
        <div class="sadWrap">
          <div class="sadEmoji">‚òπÔ∏è</div>
        </div>
        <button class="resetBtn" id="resetBtn">Reset</button>
      `;
      $("#resetBtn").addEventListener("click", () => window.location.reload());
    }

    function resetNoStateUI(){
      card.classList.remove("noState");
      askRow.style.display = "";
      noStateMount.innerHTML = "";
    }

    $("#yesBtn").addEventListener("click", () => {
      setEntered(true);
      // player stays paused until user presses play (safer for autoplay policies)
      // but we can prime UI
      updateTitle();
      // stop any ‚Äúno‚Äù state
      resetNoStateUI();
    });

    $("#noBtn").addEventListener("click", () => {
      // Keep overlay visible, but switch to NO state
      showNoState();
    });

    // ---------- Player UI Build ----------
    function buildList(){
      listEl.innerHTML = "";
      TRACKS.forEach((t, idx) => {
        const row = document.createElement("div");
        row.className = "track";
        row.dataset.idx = idx;

        const liked = likes.has(t.file);
        row.innerHTML = `
          <div class="trackLeft">
            <div class="tName">${t.title}</div>
            <div class="tArtist">${t.artist}</div>
          </div>
          <div class="tRight">
            <span class="miniHeart">${liked ? "‚ô•" : ""}</span>
            <span class="dur" id="dur-${idx}"></span>
          </div>
        `;
        row.addEventListener("click", () => {
          playIndex(idx);
          if (!player.classList.contains("open")) {
            // keep it clean on mobile
          }
        });

        listEl.appendChild(row);
      });
      highlightActive();
    }

    function highlightActive(){
      [...document.querySelectorAll(".track")].forEach(el => {
        el.classList.toggle("active", Number(el.dataset.idx) === currentIndex);
      });
    }

    function updateTitle(){
      const t = TRACKS[currentIndex];
      const playing = !audio.paused && audio.currentTime > 0;

      // Title rules:
      // - When paused (or not started) => "To My Everything üíó"
      // - When playing => "Song ‚Äî Artist" with marquee
      if (!playing){
        nowTitleEl.textContent = "To My Everything üíó";
        titleMarquee.classList.remove("playing");
      } else {
        nowTitleEl.textContent = `${t.title} ‚Äî ${t.artist}`;
        titleMarquee.classList.add("playing");
      }

      // subtitle always
      subTitleEl.textContent = "V.D 2026 playlist";

      // heart button state
      heartBtn.textContent = likes.has(t.file) ? "‚ô•" : "‚ô°";
      heartBtn.classList.toggle("on", likes.has(t.file));
    }

    function setRepeatUI(){
      repeatBtn.classList.toggle("on", repeatMode !== 0);
      // label change by mode
      repeatBtn.textContent = repeatMode === 0 ? "üîÅ" : (repeatMode === 1 ? "üîÅ" : "üîÇ");
    }

    function setShuffleUI(){
      shuffleBtn.classList.toggle("on", isShuffle);
    }

    // ---------- Audio Control ----------
    function loadTrack(idx){
      currentIndex = clamp(idx, 0, TRACKS.length-1);
      audio.src = TRACKS[currentIndex].file;
      audio.load();
      highlightActive();
      updateTitle();
      // duration after metadata loads
    }

    function playIndex(idx){
      // history for prev
      if (audio.src) history.push(currentIndex);
      loadTrack(idx);
      audio.play().catch(() => {
        // If browser blocks autoplay, user can press play
      });
      playBtn.textContent = "‚è∏";
      updateTitle();
    }

    function togglePlay(){
      if (!audio.src){
        loadTrack(currentIndex);
      }
      if (audio.paused){
        audio.play().catch(() => {});
        playBtn.textContent = "‚è∏";
      } else {
        audio.pause();
        playBtn.textContent = "‚ñ∂";
      }
      updateTitle();
    }

    function nextTrack(auto=false){
      if (repeatMode === 2 && auto){
        // repeat one
        audio.currentTime = 0;
        audio.play().catch(()=>{});
        return;
      }

      let next;
      if (isShuffle){
        // pick random different
        if (TRACKS.length === 1) next = 0;
        else {
          do { next = Math.floor(Math.random()*TRACKS.length); }
          while(next === currentIndex);
        }
      } else {
        next = currentIndex + 1;
        if (next >= TRACKS.length){
          if (repeatMode === 1) next = 0;
          else return; // repeat off
        }
      }
      playIndex(next);
    }

    function prevTrack(){
      // if current time > 3s, restart
      if (audio.currentTime > 3){
        audio.currentTime = 0;
        return;
      }
      // else go back in history if exists
      if (history.length){
        const prev = history.pop();
        playIndex(prev);
      } else {
        // fallback
        const prev = currentIndex - 1;
        playIndex(prev < 0 ? TRACKS.length-1 : prev);
      }
    }

    // ---------- Wire Buttons ----------
    playBtn.addEventListener("click", togglePlay);
    nextBtn.addEventListener("click", () => nextTrack(false));
    prevBtn.addEventListener("click", prevTrack);

    shuffleBtn.addEventListener("click", () => {
      isShuffle = !isShuffle;
      setShuffleUI();
    });

    repeatBtn.addEventListener("click", () => {
      repeatMode = (repeatMode + 1) % 3; // 0 -> 1 -> 2 -> 0
      setRepeatUI();
    });

    drawerBtn.addEventListener("click", () => {
      player.classList.toggle("open");
      drawerBtn.textContent = player.classList.contains("open") ? "‚ñ¥" : "‚ñæ";
    });

    heartBtn.addEventListener("click", () => {
      const t = TRACKS[currentIndex];
      if (likes.has(t.file)) likes.delete(t.file);
      else likes.add(t.file);
      updateTitle();
      buildList(); // refresh little hearts in list
    });

    // progress click seek
    bar.addEventListener("click", (e) => {
      const rect = bar.getBoundingClientRect();
      const pct = clamp((e.clientX - rect.left)/rect.width, 0, 1);
      if (audio.duration){
        audio.currentTime = pct * audio.duration;
      }
    });

    // audio events
    audio.addEventListener("loadedmetadata", () => {
      tDur.textContent = fmtTime(audio.duration);
      // fill track duration in list
      const d = document.getElementById(`dur-${currentIndex}`);
      if (d) d.textContent = fmtTime(audio.duration);

      // also update visible durations (best effort as user plays each track)
      const rowDur = document.getElementById(`dur-${currentIndex}`);
      if (rowDur) rowDur.textContent = fmtTime(audio.duration);

      updateTitle();
    });

    audio.addEventListener("timeupdate", () => {
      tCur.textContent = fmtTime(audio.currentTime);
      if (audio.duration){
        const pct = (audio.currentTime / audio.duration) * 100;
        barFill.style.width = pct + "%";
      }
    });

    audio.addEventListener("ended", () => {
      // auto-advance with repeat logic
      if (repeatMode === 2){
        nextTrack(true);
      } else {
        nextTrack(true);
      }
    });

    audio.addEventListener("pause", () => {
      playBtn.textContent = "‚ñ∂";
      updateTitle();
    });
    audio.addEventListener("play", () => {
      playBtn.textContent = "‚è∏";
      updateTitle();
    });

    // ---------- Init ----------
    function init(){
      buildClouds();
      buildFlies();
      buildList();
      setRepeatUI();
      setShuffleUI();
      loadTrack(0); // preload first track metadata

      // show top line animation while overlay active
      scene.classList.add("overlayActive");

      // Debug toggle
      const params = new URLSearchParams(window.location.search);
      const debug = params.get("debug") === "1";
      if (debug){
        $("#debug").classList.add("show");
        $("#dbgEnter").addEventListener("click", () => setEntered(!entered));
        $("#dbgReset").addEventListener("click", () => window.location.reload());
      }

      // Start in overlay state (not entered)
      setEntered(false);

      // Accessibility: space toggles play (only after entering)
      window.addEventListener("keydown", (e) => {
        if (e.code === "Space" && entered){
          e.preventDefault();
          togglePlay();
        }
      });
    }

    init();
  </script>
</body>
</html>
