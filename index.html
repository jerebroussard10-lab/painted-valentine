<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Painted Valentine</title>
  <style>
    :root{
      --cream:#f7f1e6;
      --ink:#1b1b1b;
      --glass: rgba(20, 20, 20, 0.28);
      --glass-2: rgba(20, 20, 20, 0.40);
      --stroke: rgba(255,255,255,0.18);
      --pink:#ff7db6;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; margin:0; }
    body{
      overflow:hidden;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:white;
      background:#000;
    }

    /* ---------- Scene layers ---------- */
    .scene{
      position:fixed;
      inset:0;
    }

    .bg{
      position:absolute;
      inset:0;
      background:url("Midnight.png") center/cover no-repeat;
      transform: scale(1.02);
      filter: saturate(1.02) contrast(1.05);
    }

    /* Tint glass (stronger before entering) */
    .glassTint{
      position:absolute;
      inset:0;
      background: rgba(10, 15, 25, 0.55);
      backdrop-filter: blur(10px);
      transition: opacity 900ms ease, backdrop-filter 900ms ease;
      opacity: 1;
      pointer-events:none;
    }
    .entered .glassTint{
      opacity: 0;
      backdrop-filter: blur(0px);
    }

    /* Soft paint texture overlay (cheap + effective) */
    .paintTexture{
      position:absolute;
      inset:-10%;
      pointer-events:none;
      opacity:0.16;
      mix-blend-mode: overlay;
      background:
        radial-gradient(circle at 15% 20%, rgba(255,255,255,0.12), transparent 45%),
        radial-gradient(circle at 70% 35%, rgba(255,255,255,0.10), transparent 50%),
        radial-gradient(circle at 45% 80%, rgba(255,255,255,0.08), transparent 55%),
        repeating-linear-gradient(25deg, rgba(255,255,255,0.06) 0px, rgba(255,255,255,0.06) 2px, transparent 2px, transparent 10px);
      filter: blur(0.3px);
      transform: rotate(-2deg);
      transition: opacity 800ms ease;
    }
    .entered .paintTexture{ opacity:0.22; } /* slightly richer once inside */

    /* Stars layer */
    .stars{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;                 /* hidden until enter */
      transition: opacity 700ms ease;
    }
    .entered .stars{ opacity:1; }

    /* Twinkle dots via pseudo elements container */
    .stars::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle, rgba(255,255,255,0.9) 0 1px, transparent 2px) 10% 20%/180px 160px,
        radial-gradient(circle, rgba(255,255,255,0.8) 0 1px, transparent 2px) 65% 30%/220px 190px,
        radial-gradient(circle, rgba(255,255,255,0.7) 0 1px, transparent 2px) 30% 65%/200px 180px,
        radial-gradient(circle, rgba(255,255,255,0.6) 0 1px, transparent 2px) 85% 75%/240px 210px,
        radial-gradient(circle, rgba(255,255,255,0.65) 0 1px, transparent 2px) 50% 10%/260px 240px;
      opacity:0.55;
      filter: blur(0.2px);
      animation: twinkle 4.6s ease-in-out infinite;
    }
    .stars::after{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle, rgba(255,255,255,0.85) 0 1px, transparent 2px) 20% 35%/260px 240px,
        radial-gradient(circle, rgba(255,255,255,0.75) 0 1px, transparent 2px) 75% 15%/300px 260px,
        radial-gradient(circle, rgba(255,255,255,0.65) 0 1px, transparent 2px) 55% 70%/280px 240px;
      opacity:0.45;
      filter: blur(0.3px);
      animation: twinkle 6.2s ease-in-out infinite reverse;
    }

    @keyframes twinkle{
      0%,100%{ opacity:0.35; transform: translateY(0px); }
      50%{ opacity:0.62; transform: translateY(-2px); }
    }

    /* Clouds layer */
    .clouds{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;                 /* hidden until enter */
      transition: opacity 700ms ease;
    }
    .entered .clouds{ opacity:1; }

    .cloud{
      position:absolute;
      top:10%;
      left:-60%;
      width:min(520px, 70vw);
      height:auto;
      opacity:0;
      filter: blur(0.2px) brightness(0.95);
      will-change: transform, opacity;
      animation: cloudDrift linear infinite;
    }

    /* One-way across + fade in/out so no ‚Äújerk‚Äù */
    @keyframes cloudDrift{
      0%   { transform: translateX(-10vw); opacity:0; }
      8%   { opacity:0.45; }
      85%  { opacity:0.45; }
      100% { transform: translateX(140vw); opacity:0; }
    }

    /* Fireflies canvas */
    #fireflies{
      position:absolute;
      inset:0;
      pointer-events:none;
      opacity:0;                 /* hidden until enter */
      transition: opacity 700ms ease;
    }
    .entered #fireflies{ opacity:1; }

    /* ---------- Intro text line ---------- */
    .introLine{
      position:absolute;
      top:7%;
      left:0; right:0;
      text-align:center;
      font-style: italic;
      font-size: clamp(16px, 2.0vw, 22px);
      color: rgba(255,255,255,0.9);
      text-shadow: 0 8px 24px rgba(0,0,0,0.55);
      opacity: 1;
      transition: opacity 1400ms ease;
      pointer-events:none;
    }
    .entered .introLine{ opacity:0; }

    /* ---------- Letter card ---------- */
    .centerWrap{
      position:absolute;
      inset:0;
      display:flex;
      align-items:center;
      justify-content:center;
      padding: 18px;
    }

    .card{
      width: min(900px, 92vw);
      border-radius: 18px;
      background: rgba(247, 241, 230, 0.96);
      color: var(--ink);
      box-shadow: 0 26px 70px rgba(0,0,0,0.45);
      padding: clamp(18px, 2.2vw, 28px);
      position: relative;
      overflow:hidden;
      transition: transform 600ms ease, opacity 600ms ease, background 600ms ease, color 600ms ease;
    }

    /* subtle paper grain */
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        radial-gradient(circle at 20% 30%, rgba(0,0,0,0.04), transparent 40%),
        radial-gradient(circle at 80% 50%, rgba(0,0,0,0.03), transparent 45%),
        repeating-linear-gradient(0deg, rgba(0,0,0,0.015), rgba(0,0,0,0.015) 1px, transparent 1px, transparent 7px);
      opacity:0.35;
      pointer-events:none;
      mix-blend-mode: multiply;
    }

    .cardInner{
      position:relative;
      z-index:1;
      display:grid;
      gap: 10px;
    }

    .hello{
      font-weight:700;
      font-size: 20px;
      margin-bottom: 2px;
    }

    .p{
      line-height:1.55;
      font-size: 17px;
      margin:0;
    }

    .sigRow{
      margin-top: 8px;
      display:flex;
      flex-direction:column;
      gap: 4px;
      font-weight:600;
    }
    .sigSmall{
      font-weight:700;
      opacity:0.75;
      font-size: 14px;
      letter-spacing: 0.02em;
    }

    .askRow{
      margin-top: 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 14px;
      flex-wrap:wrap;
    }
    .askText{
      font-weight:800;
      font-size: 20px;
    }

    .btnRow{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .btn{
      border:0;
      border-radius: 999px;
      padding: 10px 18px;
      font-weight:700;
      cursor:pointer;
      transition: transform 120ms ease, opacity 200ms ease, background 200ms ease, color 200ms ease;
      box-shadow: 0 10px 22px rgba(0,0,0,0.18);
      user-select:none;
    }
    .btn:active{ transform: scale(0.98); }

    .btnYes{
      background: #161616;
      color: white;
    }
    .btnNo{
      background: #ffffff;
      color: #111;
      border: 1px solid rgba(0,0,0,0.12);
    }

    /* Enter button appears after YES */
    .enterRow{
      display:none;
      margin-top: 12px;
      justify-content:flex-end;
    }
    .enterBtn{
      background: #161616;
      color: white;
      padding: 11px 18px;
    }

    /* NO state */
    .card.nope{
      background: rgba(14,14,14,0.88);
      color: rgba(255,255,255,0.92);
    }
    .noEmoji{
      display:none;
      width:100%;
      text-align:center;
      font-size: 38px;
      margin-top: 16px;
      margin-bottom: 6px;
    }
    .card.nope .noEmoji{
      display:block;
    }
    .resetRow{
      display:none;
      margin-top: 10px;
      justify-content:flex-start;
    }
    .resetBtn{
      background: rgba(255,255,255,0.92);
      color:#111;
      border:0;
    }

    /* Hide ask buttons when answered */
    .hidden{ display:none !important; }

    /* ---------- Player ---------- */
    .playerWrap{
      position:absolute;
      left:50%;
      bottom: 18px;
      transform: translateX(-50%);
      width: min(760px, calc(100vw - 28px));
      pointer-events:none; /* enable only on player itself */
      opacity:0;
      transition: opacity 700ms ease, transform 700ms ease;
    }
    .entered .playerWrap{
      opacity: 1;
      transform: translateX(-50%) translateY(0px);
    }

    .player{
      pointer-events:auto;
      border-radius: 18px;
      background: linear-gradient(180deg, rgba(20,20,20,0.35), rgba(20,20,20,0.22));
      backdrop-filter: blur(12px);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 22px 60px rgba(0,0,0,0.45);
      overflow:hidden;
    }

    .playerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 12px 14px 6px 14px;
    }

    .titleWrap{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .title{
      font-weight: 800;
      letter-spacing: 0.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .titleScroll{
      display:inline-block;
      padding-right: 28px;
      animation: marquee 10s linear infinite;
      will-change: transform;
    }
    .marqueeOff .titleScroll{ animation:none; }

    @keyframes marquee{
      0%{ transform: translateX(0%); }
      100%{ transform: translateX(-35%); }
    }

    .miniBtns{
      display:flex;
      gap: 8px;
      align-items:center;
    }

    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.07);
      color: rgba(255,255,255,0.92);
      display:grid;
      place-items:center;
      cursor:pointer;
      user-select:none;
    }
    .iconBtn.on{
      border-color: rgba(255,125,182,0.45);
      box-shadow: 0 0 0 2px rgba(255,125,182,0.14) inset;
    }

    .playerBody{
      padding: 6px 14px 14px 14px;
      display:grid;
      gap: 10px;
    }

    .timeRow{
      display:flex;
      justify-content:space-between;
      font-size: 12px;
      opacity:0.85;
    }

    .progress{
      width:100%;
      appearance:none;
      height: 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.18);
      outline:none;
      cursor:pointer;
    }
    .progress::-webkit-slider-thumb{
      appearance:none;
      width: 14px;
      height: 14px;
      border-radius:50%;
      background: rgba(255,255,255,0.95);
      border: 1px solid rgba(0,0,0,0.25);
      box-shadow: 0 10px 20px rgba(0,0,0,0.35);
    }

    .controls{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
      margin-top: 2px;
    }

    .ctrlLeft, .ctrlRight{
      display:flex;
      gap:10px;
      align-items:center;
    }

    .bigPlay{
      width: 46px;
      height: 46px;
      border-radius: 999px;
      background: rgba(255,255,255,0.92);
      color:#111;
      border:0;
      cursor:pointer;
      font-weight:900;
      display:grid;
      place-items:center;
      box-shadow: 0 14px 30px rgba(0,0,0,0.35);
    }

    /* Collapse */
    .collapsed .playerBody{ display:none; }
    .collapseHint{
      font-size: 12px;
      opacity:0.65;
      margin-top:-2px;
    }

    /* Mobile tweaks */
    @media (max-width:520px){
      .askText{ font-size:18px; }
      .p{ font-size:16px; }
      .playerHeader{ padding: 11px 12px 6px 12px; }
      .playerBody{ padding: 6px 12px 12px 12px; }
    }
  </style>
</head>

<body>
  <div class="scene" id="scene">
    <div class="bg"></div>
    <div class="glassTint" id="glassTint"></div>
    <div class="stars"></div>

    <!-- Clouds (multiple) -->
    <div class="clouds" id="clouds">
      <!-- We spawn these in JS so we can stagger nicely -->
    </div>

    <!-- Fireflies -->
    <canvas id="fireflies"></canvas>

    <div class="paintTexture"></div>

    <div class="introLine" id="introLine">I wanted to give you something you could stay in.</div>

    <div class="centerWrap" id="centerWrap">
      <div class="card" id="card">
        <div class="cardInner" id="cardInner">
          <div class="hello">Hello my love,</div>

          <p class="p">I can‚Äôt believe we are already having our first Valentine‚Äôs Day.</p>
          <p class="p">In a way you have been helping turn my life into a work of art.</p>
          <p class="p">So this is my little ode to you, me, and us.</p>
          <p class="p">Thank you for being my <b>Muse!</b></p>

          <div class="sigRow">
            <div>‚Äì Love Sweets üç≠</div>
            <div class="sigSmall">V.D 2026</div>
          </div>

          <div class="askRow" id="askRow">
            <div class="askText">Will you be my Valentine? üíó</div>
            <div class="btnRow" id="btnRow">
              <button class="btn btnYes" id="yesBtn">Yes</button>
              <button class="btn btnNo" id="noBtn">No</button>
            </div>
          </div>

          <div class="enterRow" id="enterRow">
            <button class="btn enterBtn" id="enterBtn">Enter the painting</button>
          </div>

          <div class="noEmoji" id="noEmoji">‚òπÔ∏è</div>
          <div class="resetRow" id="resetRow">
            <button class="btn resetBtn" id="resetBtn">Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Player (hidden until entered) -->
    <div class="playerWrap" id="playerWrap" style="opacity:0;">
      <div class="player" id="player">
        <div class="playerHeader">
          <div class="titleWrap" id="titleWrap">
            <div class="title marqueeOff" id="titleLine">
              <span class="titleScroll" id="titleScroll">To My Everything üíó</span>
            </div>
            <div class="collapseHint" id="subtitleHint">romantic playlist</div>
          </div>

          <div class="miniBtns">
            <div class="iconBtn" id="shuffleBtn" title="Shuffle">üîÄ</div>
            <div class="iconBtn" id="repeatBtn" title="Repeat">üîÅ</div>
            <div class="iconBtn" id="collapseBtn" title="Collapse / Expand">‚ñæ</div>
          </div>
        </div>

        <div class="playerBody" id="playerBody">
          <input class="progress" id="progress" type="range" min="0" max="100" value="0" />
          <div class="timeRow">
            <div id="curTime">0:00</div>
            <div id="durTime">0:00</div>
          </div>

          <div class="controls">
            <div class="ctrlLeft">
              <button class="iconBtn" id="prevBtn" title="Previous">‚èÆ</button>
              <button class="bigPlay" id="playBtn" title="Play / Pause">‚ñ∂</button>
              <button class="iconBtn" id="nextBtn" title="Next">‚è≠</button>
            </div>
            <div class="ctrlRight">
              <div class="iconBtn" id="likeBtn" title="Like">‚ô°</div>
            </div>
          </div>
        </div>

        <audio id="audio" preload="metadata"></audio>
      </div>
    </div>
  </div>

  <script>
    // -----------------------
    // Playlist (your filenames)
    // -----------------------
    const playlist = [
      { file: "everything.mp3", title: "Everything", artist: "Gotts Street Park feat. Rosie Lowe" },
      { file: "POV.mp3", title: "pov", artist: "Ariana Grande" },
      { file: "IIHANDS.mp3", title: "II HANDS II HEAVEN", artist: "Beyonc√©" },
      { file: "Sweet.mp3", title: "Sweet Love", artist: "Anita Baker" },
      { file: "OurLove.mp3", title: "Our Love", artist: "Curtis Harding & Jazmine Sullivan" },
      { file: "Floating.mp3", title: "Floating", artist: "Alina Baraz" },
      { file: "All.mp3", title: "All In", artist: "Desiree Dawson" },
      { file: "End.mp3", title: "End of the Night", artist: "Kenny G" },
      { file: "Myone.mp3", title: "My One and Only Love", artist: "John Coltrane" },
      { file: "Ribbon.mp3", title: "Ribbon in the Sky", artist: "Stevie Wonder" },
      { file: "Nothing.mp3", title: "Nothing Even Matters", artist: "Lauryn Hill" },
    ];

    // -----------------------
    // Elements
    // -----------------------
    const scene = document.getElementById("scene");
    const card = document.getElementById("card");
    const askRow = document.getElementById("askRow");
    const btnRow = document.getElementById("btnRow");
    const yesBtn = document.getElementById("yesBtn");
    const noBtn  = document.getElementById("noBtn");
    const enterRow = document.getElementById("enterRow");
    const enterBtn = document.getElementById("enterBtn");
    const resetRow = document.getElementById("resetRow");
    const resetBtn = document.getElementById("resetBtn");
    const playerWrap = document.getElementById("playerWrap");

    const cloudsEl = document.getElementById("clouds");
    const canvas = document.getElementById("fireflies");
    const ctx = canvas.getContext("2d");

    // Player
    const audio = document.getElementById("audio");
    const playBtn = document.getElementById("playBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const progress = document.getElementById("progress");
    const curTime = document.getElementById("curTime");
    const durTime = document.getElementById("durTime");
    const titleLine = document.getElementById("titleLine");
    const titleScroll = document.getElementById("titleScroll");
    const shuffleBtn = document.getElementById("shuffleBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const collapseBtn = document.getElementById("collapseBtn");
    const player = document.getElementById("player");
    const likeBtn = document.getElementById("likeBtn");

    // -----------------------
    // State
    // -----------------------
    let answeredYes = false;
    let entered = false;

    let idx = 0;
    let isPlaying = false;
    let shuffle = false;
    let repeat = false;

    // For shuffle history
    let order = playlist.map((_, i) => i);
    let shuffleBag = [];

    // Likes (local only)
    let liked = new Set();

    // -----------------------
    // Helpers
    // -----------------------
    function formatTime(sec){
      if(!isFinite(sec) || sec < 0) return "0:00";
      const m = Math.floor(sec/60);
      const s = Math.floor(sec%60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function setTitlePaused(){
      titleScroll.textContent = "To My Everything üíó";
      titleLine.classList.add("marqueeOff");
    }

    function setTitleTrack(){
      const t = playlist[idx];
      titleScroll.textContent = `${t.title} ‚Äî ${t.artist}`;
      // marquee only if long
      requestAnimationFrame(() => {
        const tooLong = titleScroll.scrollWidth > titleLine.clientWidth + 20;
        titleLine.classList.toggle("marqueeOff", !tooLong);
      });
    }

    function loadTrack(i){
      idx = (i + playlist.length) % playlist.length;
      audio.src = playlist[idx].file;
      audio.load();
      progress.value = 0;
      curTime.textContent = "0:00";
      durTime.textContent = "0:00";
      if(isPlaying){
        // Must be user-gesture initiated on iOS; here we only call play after they've clicked enter/play.
        audio.play().catch(()=>{});
      }
      setTitleTrack();
      updateLikeUI();
    }

    function nextIndex(){
      if(!shuffle) return (idx + 1) % playlist.length;

      if(shuffleBag.length === 0){
        shuffleBag = order.filter(i => i !== idx);
        // Fisher-Yates shuffle
        for(let i = shuffleBag.length - 1; i > 0; i--){
          const j = Math.floor(Math.random() * (i+1));
          [shuffleBag[i], shuffleBag[j]] = [shuffleBag[j], shuffleBag[i]];
        }
      }
      return shuffleBag.pop();
    }

    function prevIndex(){
      // simple prev
      return (idx - 1 + playlist.length) % playlist.length;
    }

    function updateLikeUI(){
      const key = playlist[idx].file;
      const on = liked.has(key);
      likeBtn.textContent = on ? "‚ô•" : "‚ô°";
      likeBtn.classList.toggle("on", on);
    }

    // -----------------------
    // YES / NO flow
    // -----------------------
    yesBtn.addEventListener("click", () => {
      answeredYes = true;

      // Replace buttons with enter button
      btnRow.classList.add("hidden");
      enterRow.style.display = "flex";

      // Slight little ‚Äúrelief‚Äù motion
      card.style.transform = "translateY(-2px)";
      setTimeout(()=> card.style.transform = "translateY(0px)", 200);
    });

    enterBtn.addEventListener("click", () => {
      entered = true;
      scene.classList.add("entered");

      // Hide card smoothly
      document.getElementById("centerWrap").style.pointerEvents = "none";
      card.style.opacity = "0";
      card.style.transform = "translateY(10px)";
      setTimeout(() => {
        document.getElementById("centerWrap").style.display = "none";
      }, 520);

      // Show player
      playerWrap.style.opacity = "1";

      // Start ambience layers
      startClouds();
      resizeCanvas();
      initFireflies();
      requestAnimationFrame(loopFireflies);

      // Load first track but keep paused until user hits play
      loadTrack(0);
      setTitlePaused();
    });

    noBtn.addEventListener("click", () => {
      // Turn card black, hide ask row, show reset + centered emoji
      card.classList.add("nope");
      askRow.classList.add("hidden");
      resetRow.style.display = "flex";
    });

    resetBtn.addEventListener("click", () => {
      // simplest: reload to restore everything cleanly
      window.location.reload();
    });

    // -----------------------
    // Clouds (staggered, full drift, fade out)
    // -----------------------
    function startClouds(){
      // Clear any existing
      cloudsEl.innerHTML = "";

      const cloudSpecs = [
        { top: 10, scale: 1.05, dur: 78, delay: 0,   op: 0.42 },
        { top: 18, scale: 0.85, dur: 92, delay: 12,  op: 0.30 },
        { top: 26, scale: 1.20, dur: 88, delay: 24,  op: 0.28 },
        { top: 14, scale: 0.95, dur: 84, delay: 36,  op: 0.33 },
        { top: 30, scale: 0.75, dur: 96, delay: 48,  op: 0.22 },
      ];

      cloudSpecs.forEach((c, n) => {
        const img = document.createElement("img");
        img.src = "cloud.png"; // your file name
        img.className = "cloud";
        img.style.top = c.top + "%";
        img.style.opacity = "0";
        img.style.transform = `translateX(-10vw) scale(${c.scale})`;
        img.style.animationDuration = c.dur + "s";
        img.style.animationDelay = c.delay + "s";
        img.style.filter = `blur(0.25px) brightness(0.92)`;
        img.style.mixBlendMode = "screen";
        img.style.setProperty("opacity", c.op);

        // Override per-element opacity inside keyframes by using a wrapper via CSS var:
        img.style.setProperty("--cloudOp", c.op);

        // Instead: set base opacity and let keyframes handle fade
        img.style.opacity = "0";
        img.style.animationName = "cloudDrift";
        img.style.animationTimingFunction = "linear";
        img.style.animationIterationCount = "infinite";

        // Slight per-cloud horizontal offset randomness
        img.style.left = (-60 - n*8) + "%";

        // Use dataset to store intended mid opacity
        img.dataset.midOpacity = String(c.op);

        cloudsEl.appendChild(img);

        // Hack: enforce mid opacity during the run by adjusting on animation events
        img.addEventListener("animationiteration", () => {
          // nothing needed; keeps staggering
        });
      });

      // Make clouds visible (entered class handles opacity on container)
    }

    // -----------------------
    // Fireflies (canvas)
    // -----------------------
    let flies = [];
    function resizeCanvas(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      canvas.width  = Math.floor(window.innerWidth * dpr);
      canvas.height = Math.floor(window.innerHeight * dpr);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    window.addEventListener("resize", () => {
      if(!entered) return;
      resizeCanvas();
      initFireflies();
    });

    function initFireflies(){
      flies = [];
      const count = Math.round(Math.min(85, Math.max(45, window.innerWidth / 18)));
      for(let i=0; i<count; i++){
        const yBias = Math.random() ** 0.55; // more near bottom
        const y = window.innerHeight * (0.55 + 0.45*yBias);
        flies.push({
          x: Math.random()*window.innerWidth,
          y,
          r: 1 + Math.random()*1.6,
          vx: (Math.random()-0.5)*0.18,
          vy: (Math.random()-0.5)*0.10,
          phase: Math.random()*Math.PI*2,
          tw: 0.7 + Math.random()*1.6
        });
      }
    }

    function loopFireflies(t){
      if(!entered) return;
      ctx.clearRect(0,0,window.innerWidth, window.innerHeight);

      // soft glow
      for(const f of flies){
        f.phase += 0.02 * f.tw;
        const flicker = 0.35 + 0.65*Math.abs(Math.sin(f.phase));

        f.x += f.vx;
        f.y += f.vy + Math.sin(f.phase)*0.05;

        // wrap
        if(f.x < -10) f.x = window.innerWidth + 10;
        if(f.x > window.innerWidth + 10) f.x = -10;
        if(f.y < window.innerHeight*0.52) f.y = window.innerHeight*0.92;
        if(f.y > window.innerHeight + 10) f.y = window.innerHeight*0.55;

        const alpha = 0.10 + 0.24*flicker;
        ctx.beginPath();
        ctx.fillStyle = `rgba(255, 205, 120, ${alpha})`;
        ctx.shadowColor = `rgba(255, 205, 120, ${alpha})`;
        ctx.shadowBlur = 14;
        ctx.arc(f.x, f.y, f.r, 0, Math.PI*2);
        ctx.fill();
      }

      requestAnimationFrame(loopFireflies);
    }

    // -----------------------
    // Player interactions
    // -----------------------
    playBtn.addEventListener("click", async () => {
      if(!entered) return; // should not happen
      try{
        if(!audio.src) loadTrack(0);

        if(audio.paused){
          await audio.play();
          isPlaying = true;
          playBtn.textContent = "‚ùö‚ùö";
          setTitleTrack();
        }else{
          audio.pause();
          isPlaying = false;
          playBtn.textContent = "‚ñ∂";
          setTitlePaused();
        }
      }catch(e){
        // If autoplay/gesture issues occur, user clicking play again will work.
        console.warn(e);
      }
    });

    prevBtn.addEventListener("click", () => {
      loadTrack(prevIndex());
      if(isPlaying) audio.play().catch(()=>{});
    });

    nextBtn.addEventListener("click", () => {
      loadTrack(nextIndex());
      if(isPlaying) audio.play().catch(()=>{});
    });

    audio.addEventListener("loadedmetadata", () => {
      durTime.textContent = formatTime(audio.duration);
    });

    audio.addEventListener("timeupdate", () => {
      if(!isFinite(audio.duration) || audio.duration <= 0) return;
      const pct = (audio.currentTime / audio.duration) * 100;
      progress.value = String(pct);
      curTime.textContent = formatTime(audio.currentTime);
    });

    progress.addEventListener("input", () => {
      if(!isFinite(audio.duration) || audio.duration <= 0) return;
      const pct = Number(progress.value) / 100;
      audio.currentTime = pct * audio.duration;
    });

    audio.addEventListener("ended", () => {
      if(repeat){
        audio.currentTime = 0;
        audio.play().catch(()=>{});
        return;
      }
      loadTrack(nextIndex());
      if(isPlaying) audio.play().catch(()=>{});
    });

    shuffleBtn.addEventListener("click", () => {
      shuffle = !shuffle;
      shuffleBtn.classList.toggle("on", shuffle);
      if(shuffle) shuffleBag = [];
    });

    repeatBtn.addEventListener("click", () => {
      repeat = !repeat;
      repeatBtn.classList.toggle("on", repeat);
    });

    collapseBtn.addEventListener("click", () => {
      player.classList.toggle("collapsed");
      collapseBtn.textContent = player.classList.contains("collapsed") ? "‚ñ∏" : "‚ñæ";
    });

    likeBtn.addEventListener("click", () => {
      const key = playlist[idx].file;
      if(liked.has(key)) liked.delete(key);
      else liked.add(key);
      updateLikeUI();
    });

    // Start paused title
    setTitlePaused();
  </script>
</body>
</html>
