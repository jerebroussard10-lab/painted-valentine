<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Painted Valentine</title>
  <style>
    :root{
      --glass: rgba(18, 18, 22, .55);
      --panel: rgba(20, 20, 26, .55);
      --panel2: rgba(20, 20, 26, .72);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --accent: rgba(255, 120, 170, .95);

      --cardCream: #f4efe4;
      --cardCream2: #efe7d8;

      --radius: 22px;

      /* Clouds positioning + speed */
      --cloudBandTop: 38vh;     /* move this up/down to sit above treeline */
      --cloudBandHeight: 22vh;  /* thickness of the cloud band */
      --cloudTravel: 110vw;     /* how far they travel */
      --cloudMinDur: 90s;       /* slow drift (min) */
      --cloudMaxDur: 120s;      /* slow drift (max) */
    }

    *{ box-sizing: border-box; }
    html, body { height:100%; margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }

    body{
      overflow:hidden;
      background:#000;
      color:var(--text);
    }

    /* Background painting */
    .scene{
      position:fixed; inset:0;
      background: url("Midnight.png") center/cover no-repeat;
      transform: translateZ(0);
    }

    /* ‚ÄúTinted glass‚Äù overlay (starts ON, fades OFF after YES) */
    .tint{
      position:fixed; inset:0;
      background: rgba(25, 30, 55, .55);
      backdrop-filter: blur(10px) saturate(1.1);
      -webkit-backdrop-filter: blur(10px) saturate(1.1);
      transition: opacity 900ms ease;
      pointer-events:none;
      opacity: 1;
    }
    .tint.off{ opacity: 0; }

    /* Stars canvas behind clouds */
    #stars {
      position:fixed; inset:0;
      pointer-events:none;
      z-index: 1;
    }

    /* Clouds layer */
    .clouds{
      position:fixed;
      left:0;
      top: var(--cloudBandTop);
      width:100%;
      height: var(--cloudBandHeight);
      pointer-events:none;
      z-index: 2;
      overflow: visible;
      opacity: .95;
      filter: blur(.2px);
    }

    .cloud{
      position:absolute;
      top: 0;
      width: 520px;
      max-width: 60vw;
      opacity: .55;
      mix-blend-mode: screen;
      will-change: transform, opacity;
    }

    /* Multiple layers for depth */
    .cloud.layer1 { opacity:.42; filter: blur(0.4px); transform: scale(1.00); }
    .cloud.layer2 { opacity:.30; filter: blur(0.9px); transform: scale(1.10); }
    .cloud.layer3 { opacity:.22; filter: blur(1.4px); transform: scale(1.18); }

    @keyframes drift {
      0%   { transform: translateX(-25vw) translateY(var(--y)) scale(var(--s)); opacity: 0; }
      10%  { opacity: var(--o); }
      90%  { opacity: var(--o); }
      100% { transform: translateX(var(--cloudTravel)) translateY(var(--y)) scale(var(--s)); opacity: 0; }
    }

    /* Top line text */
    .tagline{
      position:fixed;
      top: 7vh;
      left: 0; right:0;
      text-align:center;
      z-index: 10;
      font-style: italic;
      color: rgba(255,255,255,.92);
      text-shadow: 0 10px 30px rgba(0,0,0,.45);
      opacity: 1;
      transition: opacity 900ms ease;
      padding: 0 14px;
    }
    .tagline.fade{ opacity: 0; }

    /* Ask / No cards */
    .modalWrap{
      position:fixed; inset:0;
      display:grid;
      place-items:center;
      z-index: 20;
      padding: 18px;
    }

    .card{
      width:min(900px, 92vw);
      border-radius: var(--radius);
      box-shadow: 0 24px 80px rgba(0,0,0,.45);
      overflow:hidden;
      position:relative;
    }

    .card.cream{
      background:
        radial-gradient(1200px 500px at 30% 10%, rgba(255,255,255,.65), rgba(255,255,255,0)),
        linear-gradient(180deg, var(--cardCream), var(--cardCream2));
      color: rgba(20,20,24,.92);
    }

    .card.dark{
      background: radial-gradient(900px 500px at 20% 20%, rgba(255,255,255,.07), rgba(0,0,0,0)),
                  linear-gradient(180deg, rgba(10,10,12,.94), rgba(0,0,0,.92));
      color: rgba(255,255,255,.92);
    }

    .cardInner{
      padding: 34px 36px 26px;
    }

    .hello{
      font-weight: 700;
      font-size: 22px;
      margin: 0 0 10px;
    }
    .p{
      margin: 8px 0;
      line-height: 1.6;
      font-size: 17px;
    }
    .sig{
      margin-top: 18px;
      font-weight: 650;
    }
    .sig small{
      display:block;
      margin-top: 6px;
      opacity:.75;
      font-weight: 500;
    }

    .askRow{
      margin-top: 18px;
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
    }
    .ask{
      font-weight: 800;
      font-size: 20px;
      margin: 8px 0 0;
    }

    .btns{
      display:flex;
      gap: 10px;
      align-items:center;
    }
    button{
      border:0;
      padding: 10px 18px;
      border-radius: 999px;
      font-weight: 750;
      cursor:pointer;
      transition: transform 120ms ease, opacity 200ms ease;
    }
    button:active{ transform: scale(.98); }
    .yesBtn{ background: rgba(15,15,18,.92); color:#fff; }
    .noBtn{ background: rgba(255,255,255,.9); color: rgba(12,12,16,.92); }
    .enterBtn{
      margin-top: 14px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      background: rgba(15,15,18,.92);
      color:#fff;
      opacity: 0;
      transform: translateY(6px);
      pointer-events:none;
      transition: opacity 400ms ease, transform 400ms ease;
    }
    .enterBtn.show{
      opacity: 1;
      transform: translateY(0);
      pointer-events:auto;
    }

    /* NO state: big centered emoji */
    .sadCenter{
      display:grid;
      place-items:center;
      margin-top: 10px;
      height: 180px;
      font-size: 56px;
      opacity: .95;
    }
    .resetRow{
      display:flex;
      gap: 12px;
      align-items:center;
      margin-top: 10px;
    }
    .resetBtn{
      background: rgba(255,255,255,.92);
      color: rgba(15,15,18,.95);
      font-weight: 800;
    }

    /* Fade out modal on enter */
    .modalWrap.fadeOut{
      opacity:0;
      pointer-events:none;
      transition: opacity 900ms ease;
    }

    /* Player */
    .playerWrap{
      position:fixed;
      left: 50%;
      bottom: calc(18px + env(safe-area-inset-bottom));
      transform: translateX(-50%);
      width: min(980px, 92vw);
      z-index: 30;
      pointer-events:auto;
    }

    .player{
      border-radius: 20px;
      background: rgba(18,18,24,.42);
      backdrop-filter: blur(14px) saturate(1.25);
      -webkit-backdrop-filter: blur(14px) saturate(1.25);
      box-shadow: 0 20px 70px rgba(0,0,0,.40);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
    }

    .playerHeader{
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 14px 16px 10px;
    }

    .titleBlock{
      min-width: 0;
    }
    .titleLine{
      display:flex;
      gap: 10px;
      align-items:center;
      font-weight: 800;
      color: rgba(255,255,255,.92);
      line-height: 1.1;
    }
    .subtitle{
      margin-top: 4px;
      font-size: 12px;
      color: rgba(255,255,255,.70);
    }

    .actions{
      display:flex;
      align-items:center;
      gap: 8px;
      flex-shrink:0;
    }
    .iconBtn{
      width: 34px;
      height: 34px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
    }
    .iconBtn.on{
      background: rgba(255, 120, 170, .18);
      border-color: rgba(255, 120, 170, .30);
    }
    .iconBtn:hover{ background: rgba(255,255,255,.10); }
    .iconBtn.on:hover{ background: rgba(255, 120, 170, .22); }

    .marquee{
      display:none;
      max-width: min(520px, 52vw);
      overflow:hidden;
      white-space: nowrap;
      position:relative;
    }
    .marquee span{
      display:inline-block;
      padding-left: 100%;
      animation: marquee 12s linear infinite;
      opacity:.95;
    }
    @keyframes marquee{
      0%{ transform: translateX(0); }
      100%{ transform: translateX(-100%); }
    }

    .scrubRow{
      padding: 0 16px 10px;
      display:flex;
      align-items:center;
      gap: 10px;
      color: rgba(255,255,255,.70);
      font-size: 12px;
    }
    input[type="range"]{
      width: 100%;
      accent-color: var(--accent);
    }

    .controlsRow{
      padding: 0 16px 14px;
      display:flex;
      align-items:center;
      justify-content: center;
      gap: 14px;
    }
    .bigPlay{
      width: 54px; height: 54px;
      border-radius: 999px;
      background: rgba(255,255,255,.92);
      display:grid;
      place-items:center;
      cursor:pointer;
      border: 0;
    }
    .smallCtrl{
      width: 42px; height: 42px;
      border-radius: 999px;
      background: rgba(255,255,255,.10);
      border: 1px solid rgba(255,255,255,.14);
      display:grid;
      place-items:center;
      cursor:pointer;
      color: rgba(255,255,255,.92);
    }

    .playlist{
      border-top: 1px solid rgba(255,255,255,.10);
      padding: 10px 10px calc(12px + env(safe-area-inset-bottom));
      max-height: 210px;
      overflow:auto;
    }

    .track{
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      color: rgba(255,255,255,.90);
    }
    .track:hover{ background: rgba(255,255,255,.06); }
    .track.active{ background: rgba(255, 120, 170, .12); border: 1px solid rgba(255, 120, 170, .18); }
    .trackMeta{
      min-width:0;
    }
    .trackName{
      font-weight: 750;
      font-size: 14px;
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
    }
    .trackArtist{
      font-size: 12px;
      color: rgba(255,255,255,.68);
      white-space: nowrap;
      overflow:hidden;
      text-overflow: ellipsis;
      margin-top: 2px;
    }
    .trackDur{
      font-size: 12px;
      color: rgba(255,255,255,.62);
      flex-shrink:0;
    }

    /* Collapsible player */
    .player.collapsed .scrubRow,
    .player.collapsed .controlsRow,
    .player.collapsed .playlist{
      display:none;
    }
    .collapseCaret{
      width: 34px; height: 34px;
      border-radius: 10px;
      display:grid;
      place-items:center;
      background: rgba(255,255,255,.08);
      border: 1px solid rgba(255,255,255,.10);
      cursor:pointer;
      user-select:none;
    }

    /* Mobile tweaks */
    @media (max-width: 520px){
      .cardInner{ padding: 26px 20px 18px; }
      .p{ font-size: 16px; }
      .ask{ font-size: 18px; }
      .marquee{ max-width: 58vw; }
      .playlist{ max-height: 180px; }
    }
  </style>
</head>
<body>
  <div class="scene" aria-hidden="true"></div>
  <canvas id="stars" aria-hidden="true"></canvas>
  <div class="clouds" id="clouds" aria-hidden="true"></div>
  <div class="tint" id="tint" aria-hidden="true"></div>

  <div class="tagline" id="tagline">I wanted to give you something you could stay in.</div>

  <!-- Ask / No modal -->
  <div class="modalWrap" id="modal">
    <!-- START: Ask (cream) -->
    <div class="card cream" id="askCard">
      <div class="cardInner">
        <div class="hello">Hello my love,</div>

        <div class="p">I can‚Äôt believe we are already having our first Valentine‚Äôs Day.</div>
        <div class="p">In a way you have been helping turn my life into a work of art.</div>
        <div class="p">So this is my little ode to you, me, and us.</div>
        <div class="p">Thank you for being my <b>Muse</b>!</div>

        <div class="sig">‚Äî Love Sweets üç≠<small>V.D 2026</small></div>

        <div class="askRow">
          <div class="ask">Will you be my Valentine? üíû</div>
          <div class="btns">
            <button class="yesBtn" id="yesBtn">Yes</button>
            <button class="noBtn" id="noBtn">No</button>
          </div>
        </div>

        <button class="enterBtn" id="enterBtn">Enter the painting ‚ú®</button>
      </div>
    </div>

    <!-- NO: dark card -->
    <div class="card dark" id="noCard" style="display:none;">
      <div class="cardInner">
        <div class="hello">Hello my love,</div>
        <div class="p">I can‚Äôt believe we are already having our first Valentine‚Äôs Day.</div>
        <div class="p">In a way you have been helping turn my life into a work of art.</div>
        <div class="p">So this is my little ode to you, me, and us.</div>
        <div class="p">Thank you for being my <b>Muse</b>!</div>
        <div class="sig">‚Äî Love Sweets üç≠<small>V.D 2026</small></div>

        <div class="sadCenter">üòü</div>

        <div class="resetRow">
          <button class="resetBtn" id="resetBtn">Reset</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Player -->
  <div class="playerWrap" id="playerWrap" style="display:none;">
    <div class="player" id="player">
      <div class="playerHeader">
        <div class="titleBlock">
          <div class="titleLine">
            <div id="staticTitle">To My Everything üíó</div>
            <div class="marquee" id="marquee"><span id="marqueeText"></span></div>
          </div>
          <div class="subtitle" id="subtitle">V.D 2026 playlist</div>
        </div>

        <div class="actions">
          <div class="iconBtn" id="shuffleBtn" title="Shuffle">üîÄ</div>
          <div class="iconBtn" id="repeatBtn" title="Repeat">üîÅ</div>
          <div class="iconBtn" id="heartBtn" title="Love">‚ô°</div>
          <div class="collapseCaret" id="collapseBtn" title="Collapse">‚ñæ</div>
        </div>
      </div>

      <div class="scrubRow">
        <div id="curTime">0:00</div>
        <input id="scrub" type="range" min="0" max="100" value="0" />
        <div id="durTime">0:00</div>
      </div>

      <div class="controlsRow">
        <div class="smallCtrl" id="prevBtn" title="Previous">‚èÆ</div>
        <button class="bigPlay" id="playBtn" title="Play/Pause">‚ñ∂</button>
        <div class="smallCtrl" id="nextBtn" title="Next">‚è≠</div>
      </div>

      <div class="playlist" id="playlist"></div>
    </div>

    <audio id="audio" preload="metadata"></audio>
  </div>

  <script>
    /********************
     * STATE / PLAYLIST
     ********************/
    const tracks = [
      { file: "everything.mp3", title: "Everything", artist: "Gotts Street Park feat. Rosie Lowe", dur: "3:26" },
      { file: "POV.mp3", title: "pov", artist: "Ariana Grande", dur: "3:22" },
      { file: "IIHANDS.mp3", title: "II HANDS II HEAVEN", artist: "Beyonc√©", dur: "4:??" },
      { file: "Sweet.mp3", title: "Sweet Love", artist: "Anita Baker", dur: "4:??" },
      { file: "OurLove.mp3", title: "Our Love", artist: "Curtis Harding & Jazmine Sullivan", dur: "3:??" },
      { file: "Floating.mp3", title: "Floating", artist: "Alina", dur: "3:??" },
      { file: "All.mp3", title: "All In", artist: "Desiree Dawson", dur: "3:??" },
      { file: "End.mp3", title: "End of the Night", artist: "Kenny G", dur: "5:??" },
      { file: "Myone.mp3", title: "My One and Only Love", artist: "John Coltrane", dur: "7:??" },
      { file: "Ribbon.mp3", title: "Ribbon in the Sky", artist: "Stevie Wonder", dur: "5:37" },
      { file: "Nothing.mp3", title: "Nothing Even Matters", artist: "Lauryn Hill", dur: "5:50" },
    ];

    let accepted = false;
    let currentIndex = 0;
    let isShuffle = false;
    let isRepeat = false;
    let liked = false;

    // Build a play order for shuffle
    let order = tracks.map((_, i) => i);

    const modal = document.getElementById("modal");
    const askCard = document.getElementById("askCard");
    const noCard = document.getElementById("noCard");
    const yesBtn = document.getElementById("yesBtn");
    const noBtn = document.getElementById("noBtn");
    const enterBtn = document.getElementById("enterBtn");
    const resetBtn = document.getElementById("resetBtn");

    const tint = document.getElementById("tint");
    const tagline = document.getElementById("tagline");

    const playerWrap = document.getElementById("playerWrap");
    const player = document.getElementById("player");
    const playlistEl = document.getElementById("playlist");

    const audio = document.getElementById("audio");
    const playBtn = document.getElementById("playBtn");
    const prevBtn = document.getElementById("prevBtn");
    const nextBtn = document.getElementById("nextBtn");
    const scrub = document.getElementById("scrub");
    const curTime = document.getElementById("curTime");
    const durTime = document.getElementById("durTime");

    const shuffleBtn = document.getElementById("shuffleBtn");
    const repeatBtn = document.getElementById("repeatBtn");
    const heartBtn = document.getElementById("heartBtn");
    const collapseBtn = document.getElementById("collapseBtn");

    const staticTitle = document.getElementById("staticTitle");
    const marquee = document.getElementById("marquee");
    const marqueeText = document.getElementById("marqueeText");
    const subtitle = document.getElementById("subtitle");

    function fmtTime(sec){
      if (!isFinite(sec)) return "0:00";
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${m}:${String(s).padStart(2,"0")}`;
    }

    function rebuildOrder(){
      order = tracks.map((_, i) => i);
      if (isShuffle){
        // Fisher-Yates shuffle
        for (let i = order.length - 1; i > 0; i--){
          const j = Math.floor(Math.random() * (i + 1));
          [order[i], order[j]] = [order[j], order[i]];
        }
      }
    }

    function getOrderedIndex(){
      // find currentIndex in order
      return order.indexOf(currentIndex);
    }

    function setTitleForState(){
      // When paused: show static title only
      const isPlaying = !audio.paused && audio.currentTime > 0;
      if (!isPlaying){
        staticTitle.style.display = "block";
        marquee.style.display = "none";
        marqueeText.textContent = "";
        return;
      }

      // When playing: show marquee "Song ‚Äî Artist"
      const t = tracks[currentIndex];
      staticTitle.style.display = "none";
      marquee.style.display = "block";
      marqueeText.textContent = `${t.title} ‚Äî ${t.artist}`;
    }

    function loadTrack(idx, autoplay=false){
      currentIndex = idx;
      audio.src = tracks[idx].file;
      audio.load();
      highlightActive();
      // Update title immediately (paused state until play)
      setTitleForState();
      // Optional autoplay
      if (autoplay){
        audio.play().catch(()=>{ /* user gesture may be required */ });
      }
    }

    function highlightActive(){
      [...playlistEl.querySelectorAll(".track")].forEach((row, i)=>{
        const rowIdx = Number(row.dataset.index);
        row.classList.toggle("active", rowIdx === currentIndex);
      });
    }

    function nextTrack(){
      const pos = getOrderedIndex();
      const nextPos = (pos + 1) % order.length;
      const nextIdx = order[nextPos];
      loadTrack(nextIdx, true);
    }

    function prevTrack(){
      const pos = getOrderedIndex();
      const prevPos = (pos - 1 + order.length) % order.length;
      const prevIdx = order[prevPos];
      loadTrack(prevIdx, true);
    }

    function buildPlaylist(){
      playlistEl.innerHTML = "";
      tracks.forEach((t, i)=>{
        const row = document.createElement("div");
        row.className = "track";
        row.dataset.index = String(i);
        row.innerHTML = `
          <div class="trackMeta">
            <div class="trackName">${t.title}</div>
            <div class="trackArtist">${t.artist}</div>
          </div>
          <div class="trackDur">${t.dur}</div>
        `;
        row.addEventListener("click", ()=>{
          loadTrack(i, true);
        });
        playlistEl.appendChild(row);
      });
      highlightActive();
    }

    /********************
     * ASK FLOW
     ********************/
    yesBtn.addEventListener("click", ()=>{
      // Don‚Äôt enter immediately ‚Äî show the enter button
      enterBtn.classList.add("show");
    });

    enterBtn.addEventListener("click", ()=>{
      accepted = true;
      // Fade away the card + tint + tagline
      modal.classList.add("fadeOut");
      tint.classList.add("off");
      tagline.classList.add("fade");

      // Show player once we enter
      playerWrap.style.display = "block";

      // Start music only if they click play (safer). Load track 0.
      rebuildOrder();
      loadTrack(currentIndex, false);

      // After fade, remove modal from layout to avoid accidental click capture
      setTimeout(()=>{ modal.style.display = "none"; }, 1000);
    });

    noBtn.addEventListener("click", ()=>{
      // Swap to dark card and keep it there
      askCard.style.display = "none";
      noCard.style.display = "block";
      // Keep tint/tagline as-is (still behind glass)
    });

    resetBtn.addEventListener("click", ()=>{
      // Full reset to initial state
      accepted = false;
      askCard.style.display = "block";
      noCard.style.display = "none";
      enterBtn.classList.remove("show");

      modal.style.display = "grid";
      modal.classList.remove("fadeOut");

      tint.classList.remove("off");
      tagline.classList.remove("fade");

      playerWrap.style.display = "none";

      // stop audio
      audio.pause();
      audio.currentTime = 0;
      playBtn.textContent = "‚ñ∂";
      setTitleForState();
    });

    /********************
     * PLAYER CONTROLS
     ********************/
    playBtn.addEventListener("click", async ()=>{
      if (audio.src === "" || audio.src.endsWith("/")){
        loadTrack(currentIndex, false);
      }
      if (audio.paused){
        try{
          await audio.play();
          playBtn.textContent = "‚è∏";
        }catch(e){
          // user gesture issues should be resolved since they clicked the button
        }
      }else{
        audio.pause();
        playBtn.textContent = "‚ñ∂";
      }
      setTitleForState();
    });

    prevBtn.addEventListener("click", ()=>{
      prevTrack();
    });
    nextBtn.addEventListener("click", ()=>{
      nextTrack();
    });

    shuffleBtn.addEventListener("click", ()=>{
      isShuffle = !isShuffle;
      shuffleBtn.classList.toggle("on", isShuffle);
      rebuildOrder();
    });

    repeatBtn.addEventListener("click", ()=>{
      isRepeat = !isRepeat;
      repeatBtn.classList.toggle("on", isRepeat);
    });

    heartBtn.addEventListener("click", ()=>{
      liked = !liked;
      heartBtn.textContent = liked ? "‚ô•" : "‚ô°";
      heartBtn.classList.toggle("on", liked);
    });

    collapseBtn.addEventListener("click", ()=>{
      const collapsed = player.classList.toggle("collapsed");
      collapseBtn.textContent = collapsed ? "‚ñ¥" : "‚ñæ";
    });

    audio.addEventListener("timeupdate", ()=>{
      if (!isFinite(audio.duration) || audio.duration <= 0) return;
      scrub.value = String((audio.currentTime / audio.duration) * 100);
      curTime.textContent = fmtTime(audio.currentTime);
    });

    audio.addEventListener("loadedmetadata", ()=>{
      durTime.textContent = fmtTime(audio.duration);
      curTime.textContent = fmtTime(0);
      scrub.value = "0";
    });

    audio.addEventListener("play", ()=>{
      playBtn.textContent = "‚è∏";
      setTitleForState();
    });

    audio.addEventListener("pause", ()=>{
      playBtn.textContent = "‚ñ∂";
      setTitleForState();
    });

    audio.addEventListener("ended", ()=>{
      if (isRepeat){
        audio.currentTime = 0;
        audio.play().catch(()=>{});
        return;
      }
      nextTrack();
    });

    scrub.addEventListener("input", ()=>{
      if (!isFinite(audio.duration) || audio.duration <= 0) return;
      const pct = Number(scrub.value) / 100;
      audio.currentTime = pct * audio.duration;
    });

    /********************
     * CLOUDS (slow, staggered, sky-band anchored)
     ********************/
    const cloudsEl = document.getElementById("clouds");

    function rand(min, max){ return Math.random() * (max - min) + min; }

    function spawnCloud(layerClass){
      const img = document.createElement("img");
      img.src = "cloud.png";
      img.className = `cloud ${layerClass}`;

      const y = rand(0, 1) * (parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--cloudBandHeight")) || 22);
      const scale = rand(0.85, 1.35);
      const opacity = layerClass === "layer1" ? rand(.36, .48)
                    : layerClass === "layer2" ? rand(.24, .34)
                    : rand(.18, .28);

      const dur = rand(
        parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--cloudMinDur")) || 90,
        parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--cloudMaxDur")) || 120
      );

      const delay = rand(0, 18); // stagger
      img.style.setProperty("--y", `${rand(-6, 14)}px`);
      img.style.setProperty("--s", `${scale}`);
      img.style.setProperty("--o", `${opacity}`);

      img.style.animation = `drift ${dur}s linear ${delay}s infinite`;

      // Slightly different widths for variety
      img.style.width = `${rand(380, 720)}px`;

      cloudsEl.appendChild(img);
      return img;
    }

    function initClouds(){
      cloudsEl.innerHTML = "";
      // 3 depth layers, multiple clouds each
      const counts = { layer1: 3, layer2: 3, layer3: 2 };
      Object.entries(counts).forEach(([layer, count])=>{
        for (let i=0; i<count; i++) spawnCloud(layer);
      });
    }

    /********************
     * STARS + SHOOTING STAR (behind clouds)
     ********************/
    const canvas = document.getElementById("stars");
    const ctx = canvas.getContext("2d");

    let W=0, H=0;
    function resize(){
      W = canvas.width = Math.floor(window.innerWidth * devicePixelRatio);
      H = canvas.height = Math.floor(window.innerHeight * devicePixelRatio);
      canvas.style.width = window.innerWidth + "px";
      canvas.style.height = window.innerHeight + "px";
      buildStars();
    }
    window.addEventListener("resize", resize);

    let stars = [];
    function buildStars(){
      stars = [];
      const count = Math.floor((window.innerWidth * window.innerHeight) / 9000); // density
      for (let i=0; i<count; i++){
        stars.push({
          x: Math.random() * W,
          y: Math.random() * H * 0.62, // keep stars mostly in upper sky
          r: rand(0.6, 1.7) * devicePixelRatio,
          a: rand(0.15, 0.9),
          tw: rand(0.002, 0.01),
          phase: rand(0, Math.PI*2)
        });
      }
    }

    let shooting = null;
    function maybeSpawnShootingStar(){
      if (shooting) return;
      // ~ once every 12‚Äì25 seconds
      if (Math.random() < 0.006){
        shooting = {
          x: rand(W*0.15, W*0.85),
          y: rand(H*0.05, H*0.35),
          vx: rand(10, 16) * devicePixelRatio,
          vy: rand(4, 7) * devicePixelRatio,
          life: 0,
          max: rand(26, 40)
        };
      }
    }

    function draw(){
      ctx.clearRect(0,0,W,H);

      // Stars (twinkle)
      for (const s of stars){
        s.phase += s.tw;
        const tw = (Math.sin(s.phase) + 1) / 2; // 0..1
        const alpha = Math.min(1, Math.max(0, s.a * (0.6 + tw*0.6)));

        ctx.beginPath();
        ctx.fillStyle = `rgba(255,255,255,${alpha})`;
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fill();
      }

      // Shooting star
      maybeSpawnShootingStar();
      if (shooting){
        shooting.life += 1;
        const t = shooting.life / shooting.max;

        const x1 = shooting.x + shooting.vx * shooting.life;
        const y1 = shooting.y + shooting.vy * shooting.life;

        // tail
        const tailLen = 120 * devicePixelRatio;
        const dx = shooting.vx, dy = shooting.vy;
        const mag = Math.sqrt(dx*dx + dy*dy) || 1;
        const tx = (dx / mag) * tailLen;
        const ty = (dy / mag) * tailLen;

        const a = (1 - t) * 0.9;
        ctx.strokeStyle = `rgba(255,255,255,${a})`;
        ctx.lineWidth = 2.2 * devicePixelRatio;
        ctx.beginPath();
        ctx.moveTo(x1, y1);
        ctx.lineTo(x1 - tx, y1 - ty);
        ctx.stroke();

        // head glow
        ctx.fillStyle = `rgba(255,255,255,${a})`;
        ctx.beginPath();
        ctx.arc(x1, y1, 2.2 * devicePixelRatio, 0, Math.PI*2);
        ctx.fill();

        if (shooting.life >= shooting.max) shooting = null;
      }

      requestAnimationFrame(draw);
    }

    /********************
     * INIT
     ********************/
    buildPlaylist();
    initClouds();
    resize();
    draw();

    // Start with first track loaded (no autoplay)
    rebuildOrder();
    loadTrack(0, false);
    setTitleForState();
  </script>
</body>
</html>
